<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist v4 - JavaScript Avan√ßado</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* === Base === */
body { font-family: 'Inter', Arial, sans-serif; margin:10px; transition: background 0.3s, color 0.3s; }
.dark-mode { background:#1e1e1e; color:#f4f4f9; }
h2 { margin-top:0; cursor:pointer; transition: color 0.2s; }
h2:hover { color:#4caf50; }
.semana { border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:15px; max-width:500px; margin-left:auto; margin-right:auto; transition: background 0.3s; }
.semana.modo-revisao { background: #fff3cd !important; }
.nota { width:100%; min-height:50px; margin-top:10px; padding:8px; }
.top-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; justify-content:center; }
.progress { margin:20px 0; height:20px; background:#ddd; border-radius:10px; overflow:hidden; max-width:500px; margin-left:auto; margin-right:auto; }
.progress-bar { height:100%; width:0; background:#4caf50; text-align:center; color:white; line-height:20px; transition: width 0.3s; }
.semana-header { display:flex; justify-content:space-between; align-items:center; }
.semana-progress { font-size:0.9em; margin-top:5px; color:#666; }
.dark-mode .semana-progress { color:#ccc; }
.semana-progress-bar { width:100%; height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-top:5px; }
.semana-progress-fill { height:100%; width:0; background:#4caf50; transition: width 0.3s; }
.hidden { display:none; }
button { cursor:pointer; border:none; border-radius:5px; padding:5px 10px; background-color:#4caf50; color:white; transition: background 0.2s; }
button:hover { background-color:#45a049; }
input[type=text] { padding:5px; border-radius:5px; border:1px solid #ccc; }
.importante { color:red; font-weight:bold; cursor:pointer; margin-left:5px; }
.confete { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; font-size:24px; text-align:center; }
.badge { display:inline-block; padding:3px 6px; border-radius:5px; background:#FFD700; color:#000; margin:2px; font-size:0.8em; }
.tempo { font-size:0.8em; color:#555; margin-left:5px; }
@media (max-width:600px){ .top-bar{flex-direction:column;} .semana{max-width:95%;} }
</style>
</head>
<body>

<div class="top-bar">
  <button onclick="toggleTheme()">üåô/‚òÄÔ∏è Tema</button>
  <button onclick="exportar()">Exportar JSON</button>
  <button onclick="exportarAvancado()">Exportar Avan√ßado</button>
  <button onclick="importar()">Importar JSON</button>
  <button onclick="limpar()">Limpar Tudo</button>
  <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrar()">
  <button onclick="gerarPDF()">Exportar PDF</button>
  <button onclick="ativarModoRevisao()">Modo Revis√£o</button>
  <button onclick="exportarParaCalendario()">Exportar Calend√°rio</button>
  <button onclick="loginGoogle()">Login Google</button>
  <button onclick="salvarNoDrive()">Salvar no Drive</button>
</div>

<div id="badges-container"></div>
<div class="progress"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="conteudo"></div>
<div id="confete-container" class="confete"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ================= CONFIGURA√á√ïES =================
const BACKEND_URL = 'https://cursojs-8012.onrender.com';
const SEMANAS = 8;
const plano = {
  "Semana 1 ‚Äì Fundamentos": ["O que √© JS e onde roda", "Vari√°veis let/const/var", "Tipos de dados", "Operadores matem√°ticos e l√≥gicos", "Exerc√≠cios pr√°ticos"],
  "Semana 2 ‚Äì Controle de Fluxo": ["if/else", "Operador tern√°rio e switch", "For/While/DoWhile", "Exerc√≠cios pr√°ticos"],
  "Semana 3 ‚Äì Fun√ß√µes e Escopo": ["Declara√ß√£o de fun√ß√µes", "Arrow functions", "Escopo global/local/bloco", "setTimeout/setInterval"],
  "Semana 4 ‚Äì Arrays e Objetos": ["Arrays .push/.pop", ".map/.filter/.reduce", "Objetos: propriedades e acesso", "Itera√ß√£o em objetos"],
  "Semana 5 ‚Äì DOM": ["Selecionar elementos", "Alterar conte√∫do", "Alterar estilos", "Criar/remover elementos", "Eventos"],
  "Semana 6 ‚Äì Projeto To-Do List": ["Estrutura HTML e input", "Adicionar itens", "Marcar conclu√≠dos", "Excluir tarefas", "Salvar no localStorage"],
  "Semana 7 ‚Äì JS Moderno": ["Template literals", "Desestrutura√ß√£o", "Spread/Rest", "M√≥dulos", "fetch/Promises/async-await"],
  "Semana 8 ‚Äì Projeto Final": ["Planejar projeto", "Estruturar HTML/CSS", "Fun√ß√µes principais", "Consumir API", "Finalizar melhorias"]
};

// ================= DADOS =================
let data = JSON.parse(localStorage.getItem('data')) || { check:{}, notes:{}, dark:false, historico:[], pontos:0, badges:[] };
let modoRevisaoAtivo = false;

// ================= FUN√á√ïES AUXILIARES =================
const salvar = () => { localStorage.setItem('data', JSON.stringify(data)); atualizarProgresso(); atualizarBadges(); };
const carregar = () => { gerar(); if(data.dark) document.body.classList.add('dark-mode'); atualizarProgresso(); atualizarBadges(); };

// ================= PROGRESSO E BADGES =================
const atualizarProgresso = () => {
  let total = 0, concluidas = 0;
  Object.keys(plano).forEach((semana, idx) => {
    plano[semana].forEach((_, i) => {
      total++; if(data.check[`s${idx}d${i}`]) concluidas++;
    });
  });
  data.pontos = concluidas;
  const perc = total?Math.round((concluidas/total)*100):0;
  document.getElementById('progressBar').style.width=perc+'%';
  document.getElementById('progressBar').textContent=perc+'%';

  // Barras semana
  Object.keys(plano).forEach((semana, idx)=>{
    const tarefas=plano[semana], conclu=tarefas.filter((_,i)=>data.check[`s${idx}d${i}`]).length;
    const percSemana = tarefas.length?Math.round(conclu/tarefas.length*100):0;
    const fill=document.getElementById(`semana-progress-fill-${idx}`);
    const txt=document.getElementById(`semana-progress-${idx}`);
    if(fill) fill.style.width=percSemana+'%';
    if(txt) txt.textContent=percSemana+'% conclu√≠do';
  });
};

const atualizarBadges = () => {
  const container=document.getElementById('badges-container'); container.innerHTML='';
  Object.keys(plano).forEach((semana, idx)=>{
    const tarefas=plano[semana];
    if(tarefas.every((_,i)=>data.check[`s${idx}d${i}`])) container.appendChild(document.createElement('span')).className='badge';
  });
};

// ================= CHECKBOX/SEMANA =================
const checarConfete = idx => {
  const tarefas=plano[Object.keys(plano)[idx]];
  if(tarefas.every((_,i)=>data.check[`s${idx}d${i}`])){
    if(window.innerWidth>600){ document.getElementById('confete-container').innerHTML='üéâ'.repeat(20); setTimeout(()=>document.getElementById('confete-container').innerHTML='',1500);}
  }
};

const criarTarefa = (semana, idx, t, i)=>{
  const chk=document.createElement('input'); chk.type='checkbox'; chk.id=`s${idx}d${i}`; chk.checked=data.check[chk.id]||false;
  chk.onchange=()=>{ data.check[chk.id]=chk.checked; salvar(); atualizarProgresso(); checarConfete(idx); };
  const label=document.createElement('label'); label.htmlFor=chk.id; label.textContent=t;
  const div=document.createElement('div'); div.appendChild(chk); div.appendChild(label);
  return div;
};

const gerarSemana = (semana,tarefas,idx)=>{
  const div=document.createElement('div'); div.className='semana';
  const header=document.createElement('div'); header.className='semana-header';
  header.innerHTML=`<h2 onclick='toggleCollapse(${idx})'>${semana}</h2>`;
  div.appendChild(header);

  const progresso=document.createElement('div'); progresso.className='semana-progress'; progresso.id=`semana-progress-${idx}`; div.appendChild(progresso);
  const bar=document.createElement('div'); bar.className='semana-progress-bar'; bar.innerHTML=`<div class='semana-progress-fill' id='semana-progress-fill-${idx}'></div>`; div.appendChild(bar);

  const tarefasDiv=document.createElement('div'); tarefasDiv.id=`tarefas-${idx}`;
  tarefas.forEach((t,i)=>tarefasDiv.appendChild(criarTarefa(semana,idx,t,i)));
  div.appendChild(tarefasDiv);
  return div;
};

const gerar = ()=>{
  const container=document.getElementById('conteudo'); container.innerHTML='';
  Object.entries(plano).forEach(([semana,tarefas],idx)=> container.appendChild(gerarSemana(semana,tarefas,idx)));
  if(modoRevisaoAtivo) ativarModoRevisao();
  atualizarProgresso();
};

// ================= COLLAPSE =================
const toggleCollapse=idx=>{
  const el=document.getElementById(`tarefas-${idx}`);
  el.style.display=el.style.display==='none'?'block':'none';
};

// ================= EXPORT/IMPORT =================
const criarDownload=(json,nome)=>{
  const blob=new Blob([JSON.stringify(json,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=nome; a.click();
};

const exportar=()=>criarDownload(data,'checklist.json');
const exportarAvancado=()=>criarDownload({check:data.check,notes:data.notes,historico:data.historico,pontos:data.pontos,badges:data.badges},'checklist_avancado.json');

const importar=()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange=e=>{
    const file=e.target.files[0]; if(file){
      const reader=new FileReader();
      reader.onload=evt=>{
        try{ data=JSON.parse(evt.target.result); salvar(); carregar(); }catch{ alert("Arquivo inv√°lido!"); }
      };
      reader.readAsText(file);
    }
  }; input.click();
};

const limpar=()=>{
  if(confirm("Deseja realmente limpar todos os dados?")){
    data={check:{},notes:{},dark:false,historico:[],pontos:0,badges:[]}; localStorage.removeItem('data'); carregar();
  }
};

// ================= PDF =================
const gerarPDF=()=> html2pdf().from(document.body).save('checklist.pdf');

// ================= MODO REVIS√ÉO =================
const ativarModoRevisao=()=>{
  modoRevisaoAtivo=!modoRevisaoAtivo;
  document.querySelectorAll('.semana').forEach(div=>{
    if(modoRevisaoAtivo) div.classList.add('modo-revisao'); else div.classList.remove('modo-revisao');
  });
};

// ================= CALEND√ÅRIO =================
const exportarParaCalendario=()=>{
  let ics="BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\n";
  Object.keys(plano).forEach((semana,idx)=>{
    plano[semana].forEach((t,i)=>{
      if(data.check[`s${idx}d${i}`]){
        let dt=new Date(); let dtStr=dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
        ics+=`BEGIN:VEVENT\nSUMMARY:${t}\nDTSTART:${dtStr}\nEND:VEVENT\n`;
      }
    });
  });
  ics+="END:VCALENDAR";
  const blob=new Blob([ics],{type:'text/calendar'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='checklist.ics'; a.click();
};

// ================= TEMA =================
const toggleTheme=()=>{ document.body.classList.toggle('dark-mode'); data.dark=document.body.classList.contains('dark-mode'); salvar(); };

// ================= LOGIN GOOGLE =================
window.addEventListener('load',()=>{
  const params=new URLSearchParams(window.location.search); const tokenStr=params.get('token');
  if(tokenStr){ try{ const token=JSON.parse(decodeURIComponent(tokenStr)); localStorage.setItem('googleToken',JSON.stringify(token)); window.history.replaceState({},document.title,window.location.pathname); alert('Login Google conclu√≠do!'); }catch(e){console.error(e);} }
});

function loginGoogle(){
  fetch(`${BACKEND_URL}/auth-url`).then(res=>res.json()).then(d=>{
    const popup=window.open(d.url,"loginGoogle","width=500,height=600");
    window.addEventListener("message",function(event){ if(event.data.googleToken){ localStorage.setItem('googleToken',JSON.stringify(event.data.googleToken)); alert('Login Google conclu√≠do!'); popup.close(); }},{once:true});
  });
}

function salvarNoDrive(){
  const token=JSON.parse(localStorage.getItem('googleToken'));
  if(!token) return alert('Voc√™ precisa fazer login no Google antes.');
  fetch(`${BACKEND_URL}/save`,{
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token,filename:'checklist.json',content:data})
  }).then(res=>res.json()).then(resp=>{ if(resp.success) alert('Checklist salvo com sucesso no Google Drive!'); else alert('Erro ao salvar: '+(resp.error||'desconhecido')); }).catch(err=>alert('Erro ao salvar no Google Drive: '+err));
}

// ================= BUSCA =================
const filtrar=()=>{
  const termo=document.getElementById('busca').value.toLowerCase();
  document.querySelectorAll('.semana').forEach(s=>{ s.style.display=s.innerText.toLowerCase().includes(termo)?'block':'none'; });
};

// ================= INICIALIZA =================
window.onload=carregar;
</script>
</body>
</html>
