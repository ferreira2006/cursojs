<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist v4.3 - JavaScript Avan√ßado</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', Arial, sans-serif; margin:10px; transition: background 0.3s, color 0.3s; background:#f4f4f9; }
.dark-mode { background:#1e1e1e; color:#f4f4f9; }
h2 { margin-top:0; cursor:pointer; word-break:break-word; }
.semana { border:1px solid #ccc; border-radius:8px; padding:15px; margin-bottom:15px; transition: background 0.3s; display:flex; flex-direction:column; }
.semana.modo-revisao { background: #fff3cd !important; }
.nota { width:100%; min-height:50px; margin-top:10px; padding:8px; border-radius:5px; border:1px solid #ccc; }
.top-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.progress { margin:20px 0; height:20px; background:#ddd; border-radius:10px; overflow:hidden; }
.progress-bar { height:100%; width:0; background:#4caf50; text-align:center; color:white; line-height:20px; transition: width 0.3s; }
.semana-header { display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; }
.semana-progress { font-size:0.9em; margin-top:5px; color:#666; }
.dark-mode .semana-progress { color:#ccc; }
.semana-progress-bar { width:100%; height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-top:5px; }
.semana-progress-fill { height:100%; width:0; background:#4caf50; transition: width 0.3s; }
.hidden { display:none; }
button { cursor:pointer; border:none; border-radius:5px; padding:5px 10px; background-color:#4caf50; color:white; transition: background 0.2s; margin-top:5px; }
button:hover { background-color:#45a049; }
input[type=text] { padding:5px; border-radius:5px; border:1px solid #ccc; }
.importante { color:red; font-weight:bold; cursor:pointer; margin-left:5px; }
.confete { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
.badge { display:inline-block; padding:3px 6px; border-radius:5px; background:#FFD700; color:#000; margin:2px; font-size:0.8em; }
.tempo { font-size:0.8em; color:#555; margin-left:5px; }
.tarefa { display:flex; align-items:center; gap:8px; margin-top:5px; }
#badges-container { margin-bottom:10px; }
@media (max-width:800px){ .semana { width:100%; } }
@media (min-width:801px){ .semana { width:48%; margin-right:1%; } }
@media (max-width:600px){ .top-bar{flex-direction:column;} }
</style>
</head>
<body>

<div class="top-bar">
  <button onclick="toggleTheme()">üåô/‚òÄÔ∏è Tema</button>
  <button onclick="exportar()">Exportar JSON</button>
  <button onclick="exportarAvancado()">Exportar Avan√ßado</button>
  <button onclick="importar()">Importar JSON</button>
  <button onclick="limpar()">Limpar Tudo</button>
  <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrar()">
  <button onclick="gerarPDF()">Exportar PDF</button>
  <button onclick="ativarModoRevisao()">Modo Revis√£o</button>
  <button onclick="exportarParaCalendario()">Exportar Calend√°rio</button>
  <button onclick="loginGoogle()">Login Google</button>
  <button onclick="salvarNoDrive()">Salvar no Drive</button>
</div>

<div id="badges-container"></div>
<div class="progress"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="conteudo" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
<div id="confete-container" class="confete"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ================= BACKEND URL =================
const BACKEND_URL = 'https://cursojs-8012.onrender.com';

// ================= CHECKLIST =================
const coresSemana = ['#FFCDD2','#C8E6C9','#BBDEFB','#FFF9C4','#D1C4E9','#FFE0B2','#B2DFDB','#F8BBD0'];
const plano = {
  "Semana 1 ‚Äì Fundamentos": ["O que √© JS, onde roda, configurar ambiente.", "Vari√°veis (let, const, var) e tipos de dados.", "Operadores matem√°ticos e de compara√ß√£o.", "Operadores l√≥gicos (&&, ||, !).", "Exerc√≠cios pr√°ticos."],
  "Semana 2 ‚Äì Controle de Fluxo": ["if, else if, else.", "Operador tern√°rio e switch.", "Estruturas de repeti√ß√£o: for.", "Estruturas de repeti√ß√£o: while e do...while.", "Exerc√≠cios pr√°ticos."],
  "Semana 3 ‚Äì Fun√ß√µes e Escopo": ["Declara√ß√£o de fun√ß√µes e par√¢metros.", "Retorno de fun√ß√µes.", "Arrow functions.", "Escopo (global, local, bloco).", "Fun√ß√µes an√¥nimas, setTimeout e setInterval."],
  "Semana 4 ‚Äì Arrays e Objetos": ["Criar arrays e usar .push(), .pop().", ".map(), .filter(), .reduce().", "Objetos: propriedades e acesso (. e []).", "Itera√ß√£o em objetos (for...in, Object.keys).", "Exerc√≠cios pr√°ticos."],
  "Semana 5 ‚Äì DOM": ["Selecionar elementos (getElementById, querySelector).", "Alterar conte√∫do (innerText, innerHTML).", "Alterar estilos (.style).", "Criar e remover elementos.", "Eventos (onclick, addEventListener)."],
  "Semana 6 ‚Äì Projeto To-Do List": ["Estrutura HTML b√°sica e input para tarefas.", "Adicionar itens √† lista com JS.", "Marcar tarefas como conclu√≠das.", "Excluir tarefas.", "Salvar no localStorage."],
  "Semana 7 ‚Äì JavaScript Moderno": ["Template literals e desestrutura√ß√£o.", "Spread/rest.", "M√≥dulos (import/export).", "fetch e Promises.", "async/await."],
  "Semana 8 ‚Äì Projeto Final": ["Planejar o projeto.", "Estruturar HTML/CSS inicial.", "Criar fun√ß√µes principais.", "Consumir API (se usar).", "Finalizar e melhorias extras."]
};

let data = JSON.parse(localStorage.getItem('checklistData')) || {check:{}, notas:{}, dark:false, historico:[], pontos:0, badges:[]};
let modoRevisaoAtivo = false;

// --- Salvar/Carregar ---
const salvar = ()=>{ localStorage.setItem('checklistData', JSON.stringify(data)); atualizarProgresso(); atualizarBadges(); };
const carregar = ()=>{ gerar(); if(data.dark) document.body.classList.add('dark-mode'); atualizarProgresso(); atualizarBadges(); };

// --- Tema ---
const toggleTheme = ()=>{ document.body.classList.toggle('dark-mode'); data.dark=document.body.classList.contains('dark-mode'); salvar(); };

// --- Gerar Checklists ---
const criarTarefa = (semanaIdx,tarefaIdx,texto)=>{
  const div=document.createElement('div'); div.className='tarefa';
  const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=data.check[`s${semanaIdx}d${tarefaIdx}`]||false;
  chk.onchange=()=>{ data.check[`s${semanaIdx}d${tarefaIdx}`]=chk.checked; salvar(); atualizarProgresso(); };
  const label=document.createElement('span'); label.textContent=texto;
  div.appendChild(chk); div.appendChild(label);
  return div;
};

const gerarSemana = (titulo,tarefas,idx)=>{
  const div=document.createElement('div'); div.className='semana'; div.style.background=data.dark?`rgba(50,50,50,0.8)`:`${coresSemana[idx%coresSemana.length]}`;
  const header=document.createElement('div'); header.className='semana-header';
  header.innerHTML=`
    <h2>${titulo}</h2>
    <div>
      <button onclick="marcarTodos(${idx},true)">Marcar Todos</button>
      <button onclick="marcarTodos(${idx},false)">Resetar</button>
    </div>`;
  div.appendChild(header);

  tarefas.forEach((t,i)=> div.appendChild(criarTarefa(idx,i,t)));

  return div;
};

const gerar = ()=>{
  const container=document.getElementById('conteudo'); container.innerHTML='';
  Object.entries(plano).forEach(([semana,tarefas],idx)=>{
    container.appendChild(gerarSemana(semana,tarefas,idx));
  });
  atualizarProgresso();
};

// --- Marcar Todos ---
const marcarTodos = (idx,valor)=>{
  Object.keys(plano)[idx] && plano[Object.keys(plano)[idx]].forEach((_,i)=>{ data.check[`s${idx}d${i}`]=valor; });
  gerar();
};

// --- Progresso ---
const atualizarProgresso = ()=>{
  const totalTarefas = Object.values(plano).reduce((acc,t)=>acc+t.length,0);
  const concluidas = Object.values(data.check).filter(Boolean).length;
  const perc = totalTarefas?Math.round(concluidas/totalTarefas*100):0;
  const bar = document.getElementById('progressBar'); bar.style.width=perc+'%'; bar.textContent=perc+'%';
};

// --- Badges ---
const atualizarBadges = ()=>{
  const container=document.getElementById('badges-container'); container.innerHTML='';
  if(Object.values(data.check).filter(Boolean).length>=10) container.appendChild(Object.assign(document.createElement('span'),{className:'badge',textContent:'10 tarefas'}));
  if(Object.values(data.check).filter(Boolean).length>=20) container.appendChild(Object.assign(document.createElement('span'),{className:'badge',textContent:'20 tarefas'}));
};

// --- Busca ---
const filtrar = ()=>{
  const termo=document.getElementById('busca').value.toLowerCase();
  document.querySelectorAll('.semana').forEach(s=>{ s.style.display=s.innerText.toLowerCase().includes(termo)?'flex':'none'; });
};

// --- PDF ---
const gerarPDF = ()=> html2pdf().from(document.body).save("checklist.pdf");

// --- Modo Revis√£o ---
const ativarModoRevisao = ()=> document.querySelectorAll('.semana').forEach(s=>s.classList.toggle('modo-revisao'));

// --- Export/Import ---
const exportar = ()=>{ const blob=new Blob([JSON.stringify(data)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist.json"; a.click(); };
const exportarAvancado = ()=>{ const blob=new Blob([JSON.stringify({data,exportadoEm:new Date().toISOString()})],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist-avancado.json"; a.click(); };
const importar = ()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange=e=>{
    const file=e.target.files[0]; const reader=new FileReader();
    reader.onload=()=>{ data=JSON.parse(reader.result); salvar(); gerar(); };
    reader.readAsText(file);
  };
  input.click();
};
const limpar = ()=>{
  if(confirm("Deseja realmente limpar tudo?")){ data={check:{}, notas:{}, dark:false, historico:[], pontos:0, badges:[]}; salvar(); gerar(); }
};

// --- Calend√°rio ---
const exportarParaCalendario = ()=>{
  let ics="BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\n";
  Object.keys(plano).forEach((s,idx)=>{
    plano[s].forEach((t,i)=>{
      if(data.check[`s${idx}d${i}`]){
        const dt=new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
        ics+=`BEGIN:VEVENT\nSUMMARY:${t}\nDTSTART:${dt}\nEND:VEVENT\n`;
      }
    });
  });
  ics+="END:VCALENDAR";
  const blob=new Blob([ics],{type:'text/calendar'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist.ics"; a.click();
};

// --- LOGIN GOOGLE / SALVAR DRIVE ---
window.addEventListener('load',()=>{
  const params=new URLSearchParams(window.location.search);
  const tokenStr=params.get('token');
  if(tokenStr){
    try{
      const token=JSON.parse(decodeURIComponent(tokenStr));
      localStorage.setItem('googleToken',JSON.stringify(token));
      window.history.replaceState({},document.title,window.location.pathname);
      alert('Login Google conclu√≠do! Token salvo localmente.');
    }catch(e){console.error(e);}
  }
});

function loginGoogle(){
  fetch(`${BACKEND_URL}/auth-url`).then(r=>r.json()).then(d=>{
    const popup=window.open(d.url,"loginGoogle","width=500,height=600");
    window.addEventListener("message",function(event){
      if(event.data.googleToken){ localStorage.setItem('googleToken',JSON.stringify(event.data.googleToken)); alert('Login Google conclu√≠do!'); popup.close(); }
    },{once:true});
  });
}

function salvarNoDrive(){
  const token=JSON.parse(localStorage.getItem('googleToken'));
  if(!token) return alert('Voc√™ precisa fazer login no Google antes.');
  fetch(`${BACKEND_URL}/save`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token,filename:'checklist.json',content:data}) })
  .then(r=>r.json()).then(resp=>resp.success?alert('Checklist salvo com sucesso no Google Drive!'):alert('Erro ao salvar: '+(resp.error||'desconhecido')))
  .catch(err=>alert('Erro ao salvar no Google Drive: '+err));
}

window.onload=carregar;
</script>
</body>
</html>
