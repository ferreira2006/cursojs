<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist de Estudo - JavaScript Avan√ßado v5.2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', Arial, sans-serif; margin:0; padding-top:80px; transition: background 0.3s, color 0.3s; }
.dark-mode { background:#1e1e1e; color:#f4f4f9; }
h2 { margin-top:0; cursor:pointer; display:flex; align-items:center; gap:5px; }
.semana { border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:15px; transition: background 0.3s, color 0.3s; display:flex; flex-direction:column; }
.semana.modo-revisao { background: #fff3cd !important; }
.semana-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:5px; }
.botao-semana { padding:5px 10px; border:none; border-radius:5px; background:#4caf50; color:white; cursor:pointer; min-width:100px; flex-shrink:0; transition:0.2s, transform 0.15s, box-shadow 0.15s; }
.botao-semana:hover { background:#45a049; }
.tarefas { display:flex; flex-direction:column; gap:5px; margin-top:5px; }
.tarefas div { display:flex; align-items:center; gap:10px; }
.tarefas input { width:18px; height:18px; }
.nota { width:100%; max-width:100%; min-height:60px; padding:8px; margin-top:10px; border:1px solid #ccc; border-radius:5px; resize:vertical; box-sizing:border-box; font-family:'Inter', Arial, sans-serif; font-size:0.9em; transition: background 0.3s, color 0.3s; }
.dark-mode .nota { background:#2b2b2b; color:#f4f4f9; border-color:#555; }
.top-bar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; position:fixed; top:0; width:100%; background:#f4f4f9; padding:10px; z-index:999; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:background 0.3s; }
.dark-mode .top-bar { background:#2b2b2b; }
.top-bar-group { display:flex; gap:5px; flex-wrap:wrap; align-items:center; }
.top-bar button { background-color:#4caf50; color:#333333; border:none; border-radius:5px; padding:5px 10px; cursor:pointer; transition: background 0.2s, transform 0.15s, box-shadow 0.15s; }
.top-bar button:hover { background-color:#45a049; transform: scale(1.05); box-shadow:0 4px 10px rgba(0,0,0,0.2); }
.top-bar button:active { transform: scale(0.98); box-shadow:0 2px 5px rgba(0,0,0,0.2); }
.dropdown { position:relative; display:inline-block; }
.dropbtn { background:#4caf50; color:#333333; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; transition:0.2s; }
.dropdown-content { display:none; position:absolute; background:#f9f9f9; min-width:150px; box-shadow:0 8px 16px rgba(0,0,0,0.2); border-radius:5px; z-index:1; flex-direction:column; }
.dropdown-content button { width:100%; text-align:left; padding:8px 12px; background:none; border:none; cursor:pointer; transition:0.2s; }
.dropdown-content button:hover { background:#e0e0e0; }
.dropdown:hover .dropdown-content { display:flex; flex-direction:column; }
.busca-group input { width:200px; padding:5px; border-radius:5px; border:1px solid #ccc; }
#toast-container { position:fixed; top:20px; right:20px; z-index:10000; }
.toast { background:#333; color:white; padding:10px 15px; border-radius:5px; margin-bottom:10px; min-width:200px; box-shadow:0 2px 6px rgba(0,0,0,0.2); opacity:0; transform:translateX(100%); transition:opacity 0.3s, transform 0.3s; }
.toast.show { opacity:1; transform:translateX(0); }
.progress { margin:20px 0; height:20px; background:#ddd; border-radius:10px; overflow:hidden; }
.progress-bar { height:100%; width:0; background:#4caf50; text-align:center; color:#333333; line-height:20px; transition: width 0.3s; }
.semana-progress { font-size:0.9em; margin-top:5px; color:#666; }
.dark-mode .semana-progress { color:#ccc; }
.semana-progress-bar { width:100%; height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-top:5px; }
.semana-progress-fill { height:100%; width:0; background:#4caf50; transition: width 0.3s; }
.confete { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
.badge { display:inline-block; padding:3px 6px; border-radius:5px; background:#FFD700; color:#000; margin:2px; font-size:0.8em; }
.expand-icon { display: inline-block; margin-left: 5px; transition: transform 0.2s; }
.expand-icon.collapsed { transform: rotate(-90deg); }
.google-group { display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
.google-group .dropbtn { flex-shrink:0; }
@media (max-width:600px){ .top-bar{flex-direction:column;} .busca-group input{width:100%;} .botao-semana{width:100%;} }
</style>
</head>
<body>

<div class="top-bar">
  <div class="top-bar-group">
    <button onclick="toggleTheme()">üåô/‚òÄÔ∏è Tema</button>
    <button onclick="ativarModoRevisao()">üìù Modo Revis√£o</button>
    <button onclick="limpar()">üóëÔ∏è Limpar Tudo</button>
  </div>

  <div class="top-bar-group dropdown">
    <button class="dropbtn">üì§ Exportar</button>
    <div class="dropdown-content">
      <button onclick="exportar()">JSON</button>
      <button onclick="exportarAvancado()">Avan√ßado</button>
      <button onclick="gerarPDF()">PDF Avan√ßado</button>
      <button onclick="exportarParaCalendario()">Calend√°rio</button>
    </div>
  </div>

  <div class="top-bar-group">
    <button onclick="importar()">üì• Importar JSON</button>
  </div>

  <div class="top-bar-group google-group">
    <div class="dropdown">
      <button class="dropbtn">üîë Google</button>
      <div class="dropdown-content">
        <button onclick="loginGoogle()">Login</button>
        <button onclick="logoutGoogle()">Logout</button>
        <button onclick="salvarNoDrive()">Salvar no Drive</button>
      </div>
    </div>
    <div id="usuario-logado" style="display:flex; align-items:center; gap:5px; margin-left:10px;">
      <img id="usuario-avatar" src="" alt="Avatar" style="width:24px; height:24px; border-radius:50%; display:none;">
      <span id="usuario-email">Nenhuma conta conectada</span>
    </div>
  </div>

  <div class="top-bar-group busca-group">
    <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrar()">
  </div>
</div>

<div id="badges-container"></div>
<div class="progress"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="conteudo"></div>
<canvas id="confete-canvas" class="confete"></canvas>
<div id="toast-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ================= Dados ======================
const BACKEND_URL='https://cursojs-8012.onrender.com';
const coresSemana=['#FFCDD2','#C8E6C9','#BBDEFB','#FFF9C4','#D1C4E9','#FFE0B2','#B2DFDB','#F8BBD0'];
const plano={
  "Semana 1 ‚Äì Fundamentos":["O que √© JS, onde roda, configurar ambiente.","Vari√°veis e tipos de dados.","Operadores matem√°ticos e l√≥gicos.","Exerc√≠cios pr√°ticos."],
  "Semana 2 ‚Äì Controle de Fluxo":["if, else if, else.","Operador tern√°rio e switch.","Estruturas de repeti√ß√£o: for, while.","Exerc√≠cios pr√°ticos."],
  "Semana 3 ‚Äì Fun√ß√µes e Objetos":["Declara√ß√£o de fun√ß√µes.","Fun√ß√µes an√¥nimas e arrow.","Objetos e propriedades.","Exerc√≠cios pr√°ticos."],
  "Semana 4 ‚Äì Arrays e M√©todos":["Cria√ß√£o e itera√ß√£o de arrays.","M√©todos map, filter, reduce.","Manipula√ß√£o do DOM.","Exerc√≠cios pr√°ticos."],
  "Semana 5 ‚Äì Eventos e DOM":["Eventos de clique, submit.","Event listeners.","Manipula√ß√£o avan√ßada do DOM.","Exerc√≠cios pr√°ticos."],
  "Semana 6 ‚Äì ES6+":["Let/const, template strings.","Destructuring e spread.","Modules e import/export.","Exerc√≠cios pr√°ticos."],
  "Semana 7 ‚Äì Ass√≠ncrono":["Promises, async/await.","Fetch API.","Tratamento de erros.","Exerc√≠cios pr√°ticos."],
  "Semana 8 ‚Äì Projeto Final":["Planejamento do projeto.","Implementa√ß√£o.","Testes e depura√ß√£o.","Entrega final."]
};
let data={};
const SEMANAS=8;

// ================= Inicializa√ß√£o =================
function initData(){
  for(let i=1;i<=SEMANAS;i++){
    if(!data[i]) data[i]={nota:"",tarefas:plano[`Semana ${i} ‚Äì ${Object.keys(plano)[i-1].split('‚Äì ')[1]}`] || [], concluido:false, importante:false, progresso:0};
    else if(!data[i].tarefas) data[i].tarefas=[];
  }
}

const conteudo=document.getElementById('conteudo');
const badgesContainer=document.getElementById('badges-container');

function carregar(){
  const salvo=localStorage.getItem('checklistData');
  if(salvo) data=JSON.parse(salvo);
  initData();
  gerarSemanas();
  atualizarProgresso();
  atualizarBadges();
}

// ================= Semanas =================
function gerarSemanas(){
  conteudo.innerHTML="";
  for(let i=1;i<=SEMANAS;i++){
    const semana=document.createElement('div');
    semana.className="semana";
    const tarefasHTML=(data[i].tarefas||[]).map((t,j)=>`
      <div>
        <input type="checkbox" ${t.concluido?"checked":""} onchange="marcarTarefa(${i},${j},this.checked)">
        <span>${t.titulo || t}</span>
      </div>
    `).join("");
    semana.innerHTML=`
      <div class="semana-header">
        <h2 onclick="toggleSemana(this)">Semana ${i} <span class="expand-icon collapsed">‚ñ∂</span></h2>
        <span class="importante" onclick="marcarImportante(${i})">‚òÖ</span>
      </div>
      <div class="tarefas">${tarefasHTML}</div>
      <textarea class="nota" placeholder="Anota√ß√µes..." oninput="salvarNota(${i},this.value)">${data[i].nota}</textarea>
      <div class="semana-progress">${data[i].progresso||0}% conclu√≠do</div>
      <div class="semana-progress-bar"><div class="semana-progress-fill" style="width:${data[i].progresso||0}%"></div></div>
    `;
    conteudo.appendChild(semana);
  }
}

// ================= Fun√ß√µes =================
function salvarNota(semana,texto){ data[semana].nota=texto; salvar(); }
function marcarImportante(semana){ data[semana].importante=!data[semana].importante; salvar(); }
function marcarTarefa(semana,idx,concluido){ data[semana].tarefas[idx].concluido=concluido?1:0; salvar(); }
function salvar(){ localStorage.setItem('checklistData',JSON.stringify(data)); atualizarProgresso(); atualizarBadges(); }
function toggleSemana(el){ el.parentElement.parentElement.querySelector('.nota').classList.toggle('hidden'); el.querySelector('.expand-icon').classList.toggle('collapsed'); }
function filtrar(){ const termo=document.getElementById('busca').value.toLowerCase(); document.querySelectorAll('.semana').forEach(s=>s.style.display=s.innerText.toLowerCase().includes(termo)?"flex":"none"); }
function ativarModoRevisao(){ document.querySelectorAll('.semana').forEach(s=>s.classList.toggle('modo-revisao')); }

// ================= Progresso =================
function atualizarProgresso(){
  for(let i=1;i<=SEMANAS;i++){
    const semana=data[i];
    const concluidos=(semana.tarefas||[]).filter(t=>t.concluido).length;
    const total=(semana.tarefas||[]).length;
    semana.progresso=total?Math.round(concluidos/total*100):0;
  }
  const totalSemanas=SEMANAS;
  const totalConcluidos=Object.values(data).reduce((acc,s)=>acc+(s.progresso||0),0);
  const perc=Math.round(totalConcluidos/totalSemanas);
  document.getElementById('progressBar').style.width=perc+"%";
  document.getElementById('progressBar').textContent=perc+"%";
  document.querySelectorAll('.semana').forEach((s,i)=>{
    const fill=s.querySelector('.semana-progress-fill');
    fill.style.width=(data[i+1].progresso||0)+"%";
    s.querySelector('.semana-progress').textContent=(data[i+1].progresso||0)+"% conclu√≠do";
  });
}

// ================= Badges =================
function atualizarBadges(){
  badgesContainer.innerHTML="";
  for(let i=1;i<=SEMANAS;i++){
    if(data[i].importante){
      const badge=document.createElement('div');
      badge.className="badge";
      badge.textContent="Semana "+i+" ‚òÖ";
      badgesContainer.appendChild(badge);
    }
  }
}

// ================= Export/Import =================
function exportar(){ const blob=new Blob([JSON.stringify(data)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist.json"; a.click(); }
function exportarAvancado(){ const avancado={data,exportadoEm:new Date().toISOString()}; const blob=new Blob([JSON.stringify(avancado)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist-avancado.json"; a.click(); }
function importar(){ const input=document.createElement('input'); input.type="file"; input.accept=".json"; input.onchange=e=>{ const file=e.target.files[0]; const reader=new FileReader(); reader.onload=()=>{ data=JSON.parse(reader.result); initData(); salvar(); gerarSemanas(); }; reader.readAsText(file); }; input.click(); }
function limpar(){ if(confirm("Deseja realmente limpar tudo?")){ localStorage.removeItem('checklistData'); data={}; initData(); gerarSemanas(); atualizarProgresso(); atualizarBadges(); } }
function gerarPDF(){ html2pdf().from(document.body).save("checklist.pdf"); }
function exportarParaCalendario(){
  let ics="BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\n";
  for(let i=1;i<=SEMANAS;i++){
    if(data[i].nota){
      ics+=`BEGIN:VEVENT\nSUMMARY:Semana ${i}\nDESCRIPTION:${data[i].nota}\nDTSTART:${new Date().toISOString().replace(/[-:]/g,"").split(".")[0]}Z\nEND:VEVENT\n`;
    }
  }
  ics+="END:VCALENDAR";
  const blob=new Blob([ics],{type:"text/calendar"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist.ics"; a.click();
}

// ================= Tema =================
function toggleTheme(){document.body.classList.toggle('dark-mode');}

// ================= Login Google =================
window.addEventListener('load',()=>{
  const params=new URLSearchParams(window.location.search);
  const tokenStr=params.get('token');
  if(tokenStr){
    try{
      const token=JSON.parse(decodeURIComponent(tokenStr));
      localStorage.setItem('googleToken',JSON.stringify(token));
      console.log('Token do Google salvo localmente');
      window.history.replaceState({},document.title,window.location.pathname);
      mostrarUsuario(token);
      alert('Login Google conclu√≠do! Token salvo localmente.');
    }catch(e){console.error("Erro ao processar token do Google:",e);}
  }
});

function loginGoogle(){
  fetch(`${BACKEND_URL}/auth-url`).then(res=>res.json()).then(data=>{
    const popup=window.open(data.url,"loginGoogle","width=500,height=600");
    window.addEventListener("message",function(event){
      if(event.data.googleToken){
        localStorage.setItem('googleToken',JSON.stringify(event.data.googleToken));
        mostrarUsuario(event.data.googleToken);
        alert('Login Google conclu√≠do! Token salvo localmente.');
        popup.close();
      }
    },{once:true});
  });
}

function logoutGoogle(){
  localStorage.removeItem('googleToken');
  document.getElementById('usuario-email').textContent='Nenhuma conta conectada';
  document.getElementById('usuario-avatar').style.display='none';
  alert('Logout realizado com sucesso!');
}

function mostrarUsuario(token){
  document.getElementById('usuario-email').textContent=token.email||'Conta conectada';
  if(token.picture){ const img=document.getElementById('usuario-avatar'); img.src=token.picture; img.style.display='block'; }
}

// ================= Salvar no Drive =================
function salvarNoDrive(){
  const token=JSON.parse(localStorage.getItem('googleToken'));
  if(!token) return alert('Voc√™ precisa fazer login no Google antes.');
  fetch(`${BACKEND_URL}/save`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({token,filename:'checklist.json',content:data})
  }).then(res=>res.json()).then(resp=>{
    if(resp.success) alert('Checklist salvo com sucesso no Google Drive!');
    else alert('Erro ao salvar: '+(resp.error||'desconhecido'));
  }).catch(err=>alert('Erro ao salvar no Google Drive: '+err));
}

window.onload=carregar;
</script>
</body>
</html>
