<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist H√≠brido - JS Avan√ßado</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', Arial, sans-serif; margin:10px; transition: background 0.3s, color 0.3s; }
.dark-mode { background:#1e1e1e; color:#f4f4f9; }
h2 { margin-top:0; cursor:pointer; }
.semana { border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:15px; transition: background 0.3s; }
.semana.modo-revisao { background: #fff3cd !important; }
.nota { width:100%; min-height:50px; margin-top:10px; padding:8px; }
.top-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.progress { margin:20px 0; height:20px; background:#ddd; border-radius:10px; overflow:hidden; }
.progress-bar { height:100%; width:0; background:#4caf50; text-align:center; color:white; line-height:20px; transition: width 0.3s; }
.semana-header { display:flex; justify-content:space-between; align-items:center; }
.semana-progress { font-size:0.9em; margin-top:5px; color:#666; }
.dark-mode .semana-progress { color:#ccc; }
.semana-progress-bar { width:100%; height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-top:5px; }
.semana-progress-fill { height:100%; width:0; background:#4caf50; transition: width 0.3s; }
.hidden { display:none; }
button { cursor:pointer; border:none; border-radius:5px; padding:5px 10px; background-color:#4caf50; color:white; transition: background 0.2s; }
button:hover { background-color:#45a049; }
input[type=text] { padding:5px; border-radius:5px; border:1px solid #ccc; }
.importante { color:red; font-weight:bold; cursor:pointer; margin-left:5px; }
.confete { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
.badge { display:inline-block; padding:3px 6px; border-radius:5px; background:#FFD700; color:#000; margin:2px; font-size:0.8em; }
.tempo { font-size:0.8em; color:#555; margin-left:5px; }
#badges-container { margin-bottom:10px; }
@media (max-width:600px){ .top-bar{flex-direction:column;} }
</style>
</head>
<body>

<div class="top-bar">
  <button onclick="toggleTheme()">üåô/‚òÄÔ∏è Tema</button>
  <button onclick="exportar()">Exportar JSON</button>
  <button onclick="exportarAvancado()">Exportar Avan√ßado</button>
  <button onclick="importar()">Importar JSON</button>
  <button onclick="limpar()">Limpar Tudo</button>
  <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrar()">
  <button onclick="gerarPDF()">Exportar PDF</button>
  <button onclick="ativarModoRevisao()">Modo Revis√£o</button>
  <button onclick="exportarParaCalendario()">Exportar Calend√°rio</button>
  <button onclick="loginGoogle()">Login Google</button>
  <button onclick="salvarNoDrive()">Salvar no Drive</button>
</div>

<div id="badges-container"></div>
<div class="progress"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="conteudo"></div>
<div id="confete-container" class="confete"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ================= BACKEND URL =================
const BACKEND_URL = 'https://cursojs-8012.onrender.com';

// ================= CHECKLIST =================
const CORES_SEMANA = ['#FFCDD2','#C8E6C9','#BBDEFB','#FFF9C4','#D1C4E9','#FFE0B2','#B2DFDB','#F8BBD0'];
const NUM_SEMANAS = 8;

let data = JSON.parse(localStorage.getItem('checklistData')) || {};
let modoRevisaoAtivo = false;

// Inicializa estrutura de semanas
function initData(){
  for(let i=1;i<=NUM_SEMANAS;i++){
    if(!data[i]) data[i]={nota:"",tarefas:[],importante:false,historico:[],progresso:0};
  }
}

const conteudo=document.getElementById('conteudo');
const badgesContainer=document.getElementById('badges-container');

// ================= FUN√á√ïES =================
function carregar(){
  initData();
  gerarSemanas();
  atualizarProgresso();
  atualizarBadges();
}

function gerarSemanas(){
  conteudo.innerHTML="";
  for(let i=1;i<=NUM_SEMANAS;i++){
    const semanaDiv = document.createElement('div');
    semanaDiv.className='semana';
    semanaDiv.style.background=CORES_SEMANA[i-1];

    const tarefasHTML=(data[i].tarefas||[]).map((t,j)=>
      `<div>
        <input type="checkbox" ${t.concluido?"checked":""} onchange="marcarTarefa(${i},${j},this.checked)">
        <span>${t.titulo}</span>
      </div>`).join("");

    semanaDiv.innerHTML = `
      <div class="semana-header">
        <h2 onclick="toggleSemana(this)">Semana ${i}</h2>
        <span class="importante" onclick="marcarImportante(${i})">‚òÖ</span>
        <button onclick="marcarSemana(${i},true)">Marcar todos</button>
        <button onclick="marcarSemana(${i},false)">Resetar</button>
      </div>
      <div id="tarefas-${i}">${tarefasHTML}</div>
      <textarea class="nota" placeholder="Anota√ß√µes..." oninput="salvarNota(${i},this.value)">${data[i].nota}</textarea>
      <div class="semana-progress" id="semana-progress-${i}">${data[i].progresso||0}% conclu√≠do</div>
      <div class="semana-progress-bar"><div class="semana-progress-fill" id="semana-progress-fill-${i}" style="width:${data[i].progresso||0}%"></div></div>
    `;
    conteudo.appendChild(semanaDiv);
  }
}

function salvarNota(semana,texto){
  data[semana].nota=texto;
  salvar();
}

function marcarImportante(semana){
  data[semana].importante=!data[semana].importante;
  salvar();
}

function marcarTarefa(semana,idx,concluido){
  if(!data[semana].tarefas[idx]) data[semana].tarefas[idx]={titulo:"",concluido:false};
  data[semana].tarefas[idx].concluido=concluido;
  // Hist√≥rico
  data[semana].historico.push({tarefa:idx,status:concluido,timestamp:new Date().toISOString()});
  if(data[semana].historico.length>100) data[semana].historico.shift();
  salvar();
  // Confete se todas conclu√≠das
  if(data[semana].tarefas.every(t=>t.concluido)) mostrarConfete();
}

function mostrarConfete(){
  const confete=document.getElementById('confete-container');
  confete.innerHTML='üéâ'.repeat(20);
  setTimeout(()=>confete.innerHTML='',1500);
}

function marcarSemana(semana,marcar){
  data[semana].tarefas.forEach((t,i)=>marcarTarefa(semana,i,marcar));
  salvar();
}

function toggleSemana(el){
  const nota = el.parentElement.parentElement.querySelector('.nota');
  nota.classList.toggle('hidden');
}

function atualizarProgresso(){
  let totalConcluido=0;
  for(let i=1;i<=NUM_SEMANAS;i++){
    const semana=data[i];
    const concluidos=(semana.tarefas||[]).filter(t=>t.concluido).length;
    const total=(semana.tarefas||[]).length;
    semana.progresso = total?Math.round(concluidos/total*100):0;
    totalConcluido += semana.progresso;
    // Atualiza DOM
    const fill=document.getElementById(`semana-progress-fill-${i}`);
    const txt=document.getElementById(`semana-progress-${i}`);
    if(fill) fill.style.width=semana.progresso+'%';
    if(txt) txt.textContent=semana.progresso+'% conclu√≠do';
  }
  // Progresso total
  const perc = Math.round(totalConcluido/NUM_SEMANAS);
  document.getElementById('progressBar').style.width=perc+'%';
  document.getElementById('progressBar').textContent=perc+'%';
}

function atualizarBadges(){
  badgesContainer.innerHTML="";
  for(let i=1;i<=NUM_SEMANAS;i++){
    if(data[i].importante){
      const badge=document.createElement('div');
      badge.className='badge';
      badge.textContent=`Semana ${i} ‚òÖ`;
      badgesContainer.appendChild(badge);
    }
  }
}

function salvar(){
  localStorage.setItem('checklistData',JSON.stringify(data));
  atualizarProgresso();
  atualizarBadges();
}

// ================= EXPORT/IMPORT =================
function exportar(){
  const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist.json"; a.click();
}
function exportarAvancado(){
  const avancado={data,exportadoEm:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(avancado)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist-avancado.json"; a.click();
}
function importar(){
  const input=document.createElement('input'); input.type='file'; input.accept=".json";
  input.onchange=e=>{
    const file=e.target.files[0];
    const reader=new FileReader();
    reader.onload=()=>{
      data=JSON.parse(reader.result);
      initData();
      salvar();
      gerarSemanas();
    };
    reader.readAsText(file);
  };
  input.click();
}
function limpar(){
  if(confirm("Deseja realmente limpar tudo?")){
    localStorage.removeItem('checklistData');
    data={};
    initData();
    gerarSemanas();
    atualizarProgresso();
    atualizarBadges();
  }
}

function filtrar(){
  const termo=document.getElementById('busca').value.toLowerCase();
  document.querySelectorAll('.semana').forEach(s=>{
    s.style.display=s.innerText.toLowerCase().includes(termo)?'block':'none';
  });
}

function gerarPDF(){
  html2pdf().from(document.body).save("checklist.pdf");
}

function ativarModoRevisao(){
  modoRevisaoAtivo = !modoRevisaoAtivo;
  document.querySelectorAll('.semana').forEach(s=>{
    const incompletas = [...s.querySelectorAll('input[type=checkbox]')].some(chk=>!chk.checked);
    if(modoRevisaoAtivo && incompletas) s.classList.add('modo-revisao');
    else s.classList.remove('modo-revisao');
  });
}

// ================= Calend√°rio =================
function exportarParaCalendario(){
  let ics="BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\n";
  for(let i=1;i<=NUM_SEMANAS;i++){
    data[i].tarefas.forEach((t,j)=>{
      if(t.concluido){
        const dt = new Date();
        let dtStr = dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
        ics+=`BEGIN:VEVENT\nSUMMARY:${t.titulo}\nDTSTART:${dtStr}\nEND:VEVENT\n`;
      }
    });
  }
  ics+="END:VCALENDAR";
  const blob=new Blob([ics],{type:"text/calendar"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="checklist.ics"; a.click();
}

// ================= THEME =================
function toggleTheme(){document.body.classList.toggle('dark-mode'); data.dark=document.body.classList.contains('dark-mode'); salvar();}

// ================= LOGIN GOOGLE =================
window.addEventListener('load',()=>{
  const params=new URLSearchParams(window.location.search);
  const tokenStr=params.get('token');
  if(tokenStr){
    try{
      const token=JSON.parse(decodeURIComponent(tokenStr));
      localStorage.setItem('googleToken',JSON.stringify(token));
      console.log('Token do Google salvo localmente');
      window.history.replaceState({},document.title,window.location.pathname);
      alert('Login Google conclu√≠do! Token salvo localmente.');
    }catch(e){console.error("Erro ao processar token do Google:",e);}
  }
});

function loginGoogle(){
  fetch(`${BACKEND_URL}/auth-url`)
    .then(res=>res.json())
    .then(data=>{
      const popup=window.open(data.url,"loginGoogle","width=500,height=600");
      window.addEventListener("message",function(event){
        if(event.data.googleToken){
          localStorage.setItem('googleToken',JSON.stringify(event.data.googleToken));
          alert('Login Google conclu√≠do! Token salvo localmente.');
          popup.close();
        }
      },{once:true});
    });
}

function salvarNoDrive(){
  const token=JSON.parse(localStorage.getItem('googleToken'));
  if(!token) return alert('Voc√™ precisa fazer login no Google antes.');

  fetch(`${BACKEND_URL}/save`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({token,filename:'checklist.json',content:data})
  })
  .then(res=>res.json())
  .then(resp=>{
    if(resp.success) alert('Checklist salvo com sucesso no Google Drive!');
    else alert('Erro ao salvar: '+(resp.error||'desconhecido'));
  })
  .catch(err=>alert('Erro ao salvar no Google Drive: '+err));
}

// ================= INICIALIZA√á√ÉO =================
window.onload=carregar;
</script>

</body>
</html>
