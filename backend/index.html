<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist v4.5 - JavaScript Avan√ßado</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', Arial, sans-serif; margin:10px; transition: background 0.3s, color 0.3s; background:#f4f4f9; color:#222;}
.dark-mode { background:#1e1e1e; color:#f4f4f9; }
h2 { margin-top:0; cursor:pointer; }
.semana { border-radius:12px; padding:15px; margin-bottom:20px; transition: background 0.3s; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.semana-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:5px; }
.semana-header h2 { margin:0; flex:1; }
.semana-header .acao-btns { display:flex; gap:5px; flex-wrap:wrap; }
.semana-header .acao-btns button { flex:1; min-width:100px; }
.semana.modo-revisao { background: #fff3cd !important; }
.nota { width:100%; min-height:50px; margin-top:10px; padding:8px; border-radius:6px; border:1px solid #ccc; background:#fff; }
.dark-mode .nota { background:#333; color:#f4f4f9; border:1px solid #555; }
.top-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.progress { margin:20px 0; height:20px; background:#ddd; border-radius:10px; overflow:hidden; }
.progress-bar { height:100%; width:0; background:#4caf50; text-align:center; color:white; line-height:20px; transition: width 0.3s; }
.semana-progress { font-size:0.9em; margin-top:5px; color:#666; }
.dark-mode .semana-progress { color:#ccc; }
.semana-progress-bar { width:100%; height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-top:5px; }
.semana-progress-fill { height:100%; width:0; background:#4caf50; transition: width 0.3s; }
button { cursor:pointer; border:none; border-radius:6px; padding:5px 10px; background-color:#4caf50; color:white; transition: background 0.2s; }
button:hover { background-color:#45a049; }
input[type=text] { padding:5px; border-radius:6px; border:1px solid #ccc; flex:1; min-width:150px; }
input[type=checkbox] { transform:scale(1.3); margin-right:10px; cursor:pointer; }
.confete-canvas { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
.badge { display:inline-block; padding:3px 6px; border-radius:5px; background:#FFD700; color:#000; margin:2px; font-size:0.8em; }
@media (max-width:600px){ .top-bar{flex-direction:column;} .semana-header .acao-btns button{flex:1;} }
</style>
</head>
<body>

<div class="top-bar">
  <button onclick="toggleTheme()">üåô/‚òÄÔ∏è Tema</button>
  <button onclick="exportar()">Exportar JSON</button>
  <button onclick="exportarAvancado()">Exportar Avan√ßado</button>
  <button onclick="importar()">Importar JSON</button>
  <button onclick="limpar()">Limpar Tudo</button>
  <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrar()">
  <button onclick="gerarPDF()">Exportar PDF</button>
  <button onclick="ativarModoRevisao()">Modo Revis√£o</button>
  <button onclick="exportarParaCalendario()">Exportar Calend√°rio</button>
  <button onclick="loginGoogle()">Login Google</button>
  <button onclick="salvarNoDrive()">Salvar no Drive</button>
</div>

<div id="badges-container"></div>
<div class="progress"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="conteudo"></div>
<canvas id="confeteCanvas" class="confete-canvas"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ================= BACKEND URL =================
const BACKEND_URL = 'https://cursojs-8012.onrender.com';

// ================= CHECKLIST =================
const coresSemana = ['#FFCDD2','#C8E6C9','#BBDEFB','#FFF9C4','#D1C4E9','#FFE0B2','#B2DFDB','#F8BBD0'];
const plano = {
  "Semana 1 ‚Äì Fundamentos": ["O que √© JS, onde roda, configurar ambiente.","Vari√°veis (let, const, var) e tipos de dados.","Operadores matem√°ticos e de compara√ß√£o.","Operadores l√≥gicos (&&, ||, !).","Exerc√≠cios pr√°ticos."],
  "Semana 2 ‚Äì Controle de Fluxo": ["if, else if, else.","Operador tern√°rio e switch.","Estruturas de repeti√ß√£o: for.","while e do...while.","Exerc√≠cios pr√°ticos."],
  "Semana 3 ‚Äì Fun√ß√µes e Escopo": ["Declara√ß√£o de fun√ß√µes e par√¢metros.","Retorno de fun√ß√µes.","Arrow functions.","Escopo (global, local, bloco).","Fun√ß√µes an√¥nimas, setTimeout e setInterval."],
  "Semana 4 ‚Äì Arrays e Objetos": ["Criar arrays e usar .push(), .pop().",".map(), .filter(), .reduce().","Objetos: propriedades e acesso.","Itera√ß√£o em objetos.","Exerc√≠cios pr√°ticos."],
  "Semana 5 ‚Äì DOM": ["Selecionar elementos (getElementById, querySelector).","Alterar conte√∫do (innerText, innerHTML).","Alterar estilos (.style).","Criar e remover elementos.","Eventos (onclick, addEventListener)."],
  "Semana 6 ‚Äì Projeto To-Do List": ["Estrutura HTML b√°sica e input para tarefas.","Adicionar itens √† lista com JS.","Marcar tarefas como conclu√≠das.","Excluir tarefas.","Salvar no localStorage."],
  "Semana 7 ‚Äì JS Moderno": ["Template literals e desestrutura√ß√£o.","Spread/rest.","M√≥dulos (import/export).","fetch e Promises.","async/await."],
  "Semana 8 ‚Äì Projeto Final": ["Planejar projeto (ex.: clima, quiz).","Estruturar HTML/CSS inicial.","Criar fun√ß√µes principais.","Consumir API.","Finalizar e melhorias extras."]
};

let data = JSON.parse(localStorage.getItem('data')) || { check:{}, notes:{}, dark:false, historico:[], pontos:0, badges:[] };
let modoRevisaoAtivo = false;

// --- LocalStorage ---
const salvar = () => {
  localStorage.setItem('data', JSON.stringify(data));
  atualizarProgresso();
  atualizarBadges();
};

const carregar = () => {
  gerar();
  if(data.dark) document.body.classList.add('dark-mode');
  atualizarProgresso();
  atualizarBadges();
};

// --- Fun√ß√µes de interface ---
const atualizarProgresso = () => {
  const totalTarefas = Object.keys(data.check).length;
  const concluidas = Object.values(data.check).filter(Boolean).length;
  const perc = totalTarefas ? Math.round((concluidas/totalTarefas)*100) : 0;
  document.getElementById('progressBar').style.width = perc + '%';
  document.getElementById('progressBar').textContent = perc + '%';
};

const atualizarBadges = () => {
  const container = document.getElementById('badges-container');
  container.innerHTML='';
  Object.keys(plano).forEach((semana,i)=>{
    const tarefas = plano[semana];
    const conclu = tarefas.filter((_,j)=>data.check[`s${i}d${j}`]).length;
    if(conclu === tarefas.length){
      const badge = document.createElement('div');
      badge.className='badge';
      badge.textContent=semana+" ‚úîÔ∏è";
      container.appendChild(badge);
    }
  });
};

// --- Tema ---
const toggleTheme = () => {
  document.body.classList.toggle('dark-mode');
  data.dark=document.body.classList.contains('dark-mode');
  salvar();
};

// --- Criar tarefas ---
const criarTarefa = (semana, idx, t, i) => {
  const chk=document.createElement('input');
  chk.type='checkbox'; chk.id=`s${idx}d${i}`; chk.checked = data.check[chk.id]||false;
  chk.onchange=()=>{ data.check[chk.id]=chk.checked; salvar(); if(modoRevisaoAtivo) ativarModoRevisao(); };
  const label=document.createElement('label'); label.htmlFor=chk.id; label.textContent=t;
  const div=document.createElement('div'); div.style.display='flex'; div.style.alignItems='center'; div.style.margin='4px 0';
  div.appendChild(chk); div.appendChild(label);
  return div;
};

const marcarSemana = (idx, marcar) => {
  plano[Object.keys(plano)[idx]].forEach((_,i)=>{ data.check[`s${idx}d${i}`]=marcar; });
  salvar();
  gerar();
};

const gerarSemana = (semana, tarefas, idx) => {
  const div=document.createElement('div'); div.className='semana'; div.style.background=coresSemana[idx%coresSemana.length];
  const header=document.createElement('div'); header.className='semana-header';
  header.innerHTML=`<h2 onclick='toggleCollapse(${idx})'>${semana}</h2>
  <div class='acao-btns'>
    <button onclick='marcarSemana(${idx},true)'>Marcar Todos</button>
    <button onclick='marcarSemana(${idx},false)'>Resetar</button>
  </div>`;
  div.appendChild(header);
  const progressoDiv=document.createElement('div'); progressoDiv.className='semana-progress'; div.appendChild(progressoDiv);
  const progressBarDiv=document.createElement('div'); progressBarDiv.className='semana-progress-bar';
  progressBarDiv.innerHTML=`<div class='semana-progress-fill' id='semana-progress-fill-${idx}'></div>`;
  div.appendChild(progressBarDiv);
  const tarefasDiv=document.createElement('div'); tarefas.forEach((t,i)=>tarefasDiv.appendChild(criarTarefa(semana, idx, t, i)));
  div.appendChild(tarefasDiv);
  return div;
};

const gerar = () => {
  const container=document.getElementById('conteudo'); container.innerHTML='';
  Object.entries(plano).forEach(([semana,tarefas],idx)=>container.appendChild(gerarSemana(semana,tarefas,idx)));
  atualizarProgresso();
  atualizarBadges();
};

// --- Collapse ---
const toggleCollapse = idx => {
  const tarefas=document.querySelectorAll(`#conteudo .semana`)[idx].querySelectorAll('div')[2];
  tarefas.style.display = tarefas.style.display==='none'?'block':'flex';
};

// --- Busca ---
const filtrar = () => {
  const termo=document.getElementById('busca').value.toLowerCase();
  document.querySelectorAll('.semana').forEach(s=>{
    s.style.display = s.innerText.toLowerCase().includes(termo)?'block':'none';
  });
};

// --- Limpar e Importar/Exportar ---
const limpar = () => { if(confirm("Deseja realmente limpar todos os dados?")){ data={check:{}, notes:{}, dark:false, historico:[], pontos:0, badges:[]}; localStorage.removeItem('data'); carregar(); } };
const criarDownload = (json,nome)=>{ const blob=new Blob([JSON.stringify(json,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=nome; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); };
const exportar=()=>criarDownload(data,'checklist.json');
const exportarAvancado=()=>criarDownload({check:data.check, notes:data.notes, historico:data.historico, pontos:data.pontos, badges:data.badges},'checklist_avancado.json');

const gerarPDF=()=>html2pdf().from(document.getElementById('conteudo')).save('checklist.pdf');
const ativarModoRevisao=()=>{ modoRevisaoAtivo=!modoRevisaoAtivo; document.querySelectorAll('.semana').forEach(div=>div.classList.toggle('modo-revisao')); };

// --- Exportar Calend√°rio ---
const exportarParaCalendario=()=>{
  let ics="BEGIN:VCALENDAR\nVERSION:2.0\n";
  Object.keys(plano).forEach((semana,idx)=>{
    plano[semana].forEach((t,i)=>{
      if(data.check[`s${idx}d${i}`]){
        const dt=new Date(); dt.setDate(dt.getDate()+idx*7);
        const dtStr=dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
        ics+=`BEGIN:VEVENT\nSUMMARY:${t}\nDTSTART:${dtStr}\nEND:VEVENT\n`;
      }
    });
  });
  ics+="END:VCALENDAR";
  const blob=new Blob([ics],{type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='checklist.ics'; a.click();
};

// ================= LOGIN GOOGLE =================
window.addEventListener('load',()=>{
  const params=new URLSearchParams(window.location.search);
  const tokenStr=params.get('token');
  if(tokenStr){
    try{
      const token=JSON.parse(decodeURIComponent(tokenStr));
      localStorage.setItem('googleToken',JSON.stringify(token));
      console.log('Token do Google salvo localmente');
      window.history.replaceState({},document.title,window.location.pathname);
      alert('Login Google conclu√≠do! Token salvo localmente.');
    }catch(e){console.error("Erro ao processar token do Google:",e);}
  }
});

function loginGoogle(){
  fetch(`${BACKEND_URL}/auth-url`)
  .then(res=>res.json())
  .then(data=>{
    const popup=window.open(data.url,"loginGoogle","width=500,height=600");
    window.addEventListener("message",function(event){
      if(event.data.googleToken){
        localStorage.setItem('googleToken',JSON.stringify(event.data.googleToken));
        alert('Login Google conclu√≠do! Token salvo localmente.');
        popup.close();
      }
    },{once:true});
  });
}

function salvarNoDrive(){
  const token=JSON.parse(localStorage.getItem('googleToken'));
  if(!token) return alert('Voc√™ precisa fazer login no Google antes.');
  fetch(`${BACKEND_URL}/save`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({token,filename:'checklist.json',content:data})
  })
  .then(res=>res.json())
  .then(resp=>{ if(resp.success) alert('Checklist salvo com sucesso no Google Drive!'); else alert('Erro ao salvar: '+(resp.error||'desconhecido')); })
  .catch(err=>alert('Erro ao salvar no Google Drive: '+err));
}

// ================= CONFETE CANVAS =================
const canvas=document.getElementById('confeteCanvas'); const ctx=canvas.getContext('2d');
let confetes=[];
canvas.width=window.innerWidth; canvas.height=window.innerHeight;

function Confete(){ this.x=Math.random()*canvas.width; this.y=Math.random()*-canvas.height; this.size=Math.random()*8+4; this.speed=Math.random()*3+2; this.angle=Math.random()*2*Math.PI; this.color=`hsl(${Math.random()*360},100%,50%)`; }
function criarConfete(){ for(let i=0;i<50;i++) confetes.push(new Confete()); }
function animarConfete(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  confetes.forEach((c,i)=>{
    c.y+=c.speed; c.x+=Math.sin(c.angle)*2; c.angle+=0.05;
    ctx.fillStyle=c.color; ctx.fillRect(c.x,c.y,c.size,c.size);
    if(c.y>canvas.height) confetes.splice(i,1);
  });
  requestAnimationFrame(animarConfete);
}
function soltarConfete(){ criarConfete(); animarConfete(); }

// ================= INICIAR =================
window.onload=()=>{ carregar(); };
</script>
</body>
</html>
