<script>
// ================= Dados ======================
const coresSemana=['#FFCDD2','#C8E6C9','#BBDEFB','#FFF9C4','#D1C4E9','#FFE0B2','#B2DFDB','#F8BBD0'];
const plano={
  "Semana 1 – Fundamentos":["O que é JS, onde roda, configurar ambiente.","Variáveis e tipos de dados.","Operadores matemáticos e lógicos.","Exercícios práticos."],
  "Semana 2 – Controle de Fluxo":["if, else if, else.","Operador ternário e switch.","Estruturas de repetição: for, while, do...while.","Exercícios práticos."],
  "Semana 3 – Funções e Escopo":["Declaração de funções.","Arrow functions.","Escopo global, local e de bloco.","setTimeout e setInterval."],
  "Semana 4 – Arrays e Objetos":["Criar arrays e usar .push(), .pop().",".map(), .filter(), .reduce().","Objetos e iteração.","Exercícios práticos."],
  "Semana 5 – DOM":["Selecionar elementos e alterar conteúdo.","Alterar estilos e criar/remover elementos.","Eventos: onclick, addEventListener.","Exercícios práticos."],
  "Semana 6 – Projeto To-Do List":["Estrutura HTML e input para tarefas.","Adicionar itens à lista.","Marcar como concluído.","Excluir tarefas.","Salvar no localStorage."],
  "Semana 7 – JS Moderno":["Template literals, desestruturação.","Spread/rest, módulos.","fetch e Promises.","async/await."],
  "Semana 8 – Projeto Final":["Planejar projeto.","Estruturar HTML/CSS.","Criar funções principais.","Consumir API.","Finalizar e melhorias extras."]
};
const BACKEND_URL='https://cursojs-8012.onrender.com';
let data = JSON.parse(localStorage.getItem('data')) || { check: {}, notes: {}, dark:false, historico:[], pontos:0, badges:[] };
let modoRevisaoAtivo=false;

// ================= Toast ======================
const showToast=(msg,duration=3000)=>{
  const container=document.getElementById('toast-container');
  const toast=document.createElement('div'); 
  toast.className='toast'; 
  toast.textContent=msg;
  container.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'),50);
  setTimeout(()=>{ toast.classList.remove('show'); setTimeout(()=>container.removeChild(toast),300); },duration);
};

// ================= Confete ======================
const confeteCanvas = document.getElementById('confete-canvas');
const ctx = confeteCanvas.getContext('2d');
confeteCanvas.width = window.innerWidth;
confeteCanvas.height = window.innerHeight;
const confete = {
  particles: [],
  cores: ['#FF595E','#FFCA3A','#8AC926','#1982C4','#6A4C93','#FF924C','#6FFFE9','#FF6FFF'],
  start(count = 150){
    for(let i=0;i<count;i++){
      this.particles.push({
        x:Math.random()*confeteCanvas.width,
        y:Math.random()*confeteCanvas.height-confeteCanvas.height,
        dx:(Math.random()-0.5)*6,
        dy:Math.random()*6+2,
        size:Math.random()*8+4,
        color:this.cores[Math.floor(Math.random()*this.cores.length)],
        angle:Math.random()*360,
        spin:Math.random()*0.2-0.1,
        life:Math.random()*80+80
      });
    }
    this.animate();
    setTimeout(()=>{ this.particles=[]; ctx.clearRect(0,0,confeteCanvas.width,confeteCanvas.height); },6000);
  },
  animate(){
    ctx.clearRect(0,0,confeteCanvas.width,confeteCanvas.height);
    this.particles.forEach(p=>{
      p.x+=p.dx; p.y+=p.dy; p.angle+=p.spin; p.life-=2;
      const rad=p.angle*Math.PI/180;
      ctx.fillStyle=p.color;
      ctx.beginPath(); ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(rad);
      ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
      ctx.restore();
      p.size*=0.98;
    });
    this.particles=this.particles.filter(p=>p.life>0);
    if(this.particles.length>0) requestAnimationFrame(()=>this.animate());
  }
};
window.addEventListener('resize',()=>{ confeteCanvas.width=window.innerWidth; confeteCanvas.height=window.innerHeight; });

// ================= Funções ======================
const salvarDados=()=>{ localStorage.setItem('data',JSON.stringify(data)); atualizarProgresso(); atualizarBadges(); };

const criarTarefa=(semana,idx,t,i)=>{
  const chk=document.createElement('input'); chk.type='checkbox'; chk.id=`s${idx}d${i}`;
  chk.checked=data.check[chk.id]||false;
  chk.onchange=()=>{ data.check[chk.id]=chk.checked; salvarDados(); checarConfete(idx); if(modoRevisaoAtivo) ativarModoRevisao(); };
  const label=document.createElement('span'); label.textContent=t;
  const div=document.createElement('div'); div.appendChild(chk); div.appendChild(label);
  return div;
};

const gerarSemana=(semana,tarefas,idx)=>{
   const div = document.createElement('div');
  div.className = 'semana';
  div.style.background = coresSemana[idx % coresSemana.length];

  // Header
  const header = document.createElement('div');
  header.className = 'semana-header';
  header.innerHTML = `
    <h2 onclick="toggleCollapse(${idx})">
      ${semana} <span class="expand-icon collapsed">▼</span>
    </h2>
    <div style="display:flex;gap:5px;flex-wrap:wrap;">
      <button class="botao-semana" onclick="marcarSemana(${idx},true)">Marcar Todos</button>
      <button class="botao-semana" onclick="marcarSemana(${idx},false)">Resetar</button>
    </div>
  `;
  div.appendChild(header);

  // Progresso
  const progresso = document.createElement('div');
  progresso.className = 'semana-progress';
  progresso.id = `semana-progress-${idx}`;
  div.appendChild(progresso);

  const progressBar = document.createElement('div');
  progressBar.className = 'semana-progress-bar';
  progressBar.innerHTML = `<div class='semana-progress-fill' id='semana-progress-fill-${idx}'></div>`;
  div.appendChild(progressBar);

  // Tarefas
  const tarefasDiv = document.createElement('div');
  tarefasDiv.className = 'tarefas';
  tarefasDiv.id = `tarefas-${idx}`;
  tarefasDiv.style.display = 'none'; // inicia colapsada
  tarefas.forEach((t, i) => tarefasDiv.appendChild(criarTarefa(semana, idx, t, i)));
  div.appendChild(tarefasDiv);

  return div;
};

const gerar=()=>{
  const container=document.getElementById('conteudo'); container.innerHTML='';
  Object.entries(plano).forEach(([semana,tarefas],idx)=>container.appendChild(gerarSemana(semana,tarefas,idx)));
  atualizarProgresso(); if(modoRevisaoAtivo) ativarModoRevisao();
};

const marcarSemana=(idx,marcar)=>{ document.querySelectorAll(`#tarefas-${idx} input`).forEach(chk=>{ chk.checked=marcar; data.check[chk.id]=marcar; }); salvarDados(); };

const checarConfete=(idx)=>{ if([...document.querySelectorAll(`#tarefas-${idx} input`)].every(i=>i.checked)) confete.start(); };

const toggleCollapse=idx=>{
  const el=document.getElementById(`tarefas-${idx}`);
  const icon=document.querySelectorAll('.expand-icon')[idx];
  if(el.style.display==='none'){ el.style.display='flex'; icon.classList.remove('collapsed'); } 
  else { el.style.display='none'; icon.classList.add('collapsed'); }
};

const filtrar=()=>{ const termo=document.getElementById('busca').value.toLowerCase(); document.querySelectorAll('.semana').forEach(div=>{ div.style.display=div.innerText.toLowerCase().includes(termo)?'flex':'none'; }); };

const ativarModoRevisao=()=>{
  modoRevisaoAtivo=!modoRevisaoAtivo;
  document.querySelectorAll('.semana').forEach(div=>{
    if(modoRevisaoAtivo && [...div.querySelectorAll('input')].some(i=>!i.checked)) div.classList.add('modo-revisao');
    else div.classList.remove('modo-revisao');
  });
};

// ================= Export/Import ======================
const exportar=()=>{ const blob=new Blob([JSON.stringify(data)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='checklist.json'; a.click(); showToast('Exportado JSON'); };
const exportarAvancado=()=>{ const blob=new Blob([JSON.stringify({data,exportadoEm:new Date().toISOString()})],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='checklist-avancado.json'; a.click(); showToast('Exportado JSON Avançado'); };
const importar=()=>{ const input=document.createElement('input'); input.type='file'; input.accept='.json'; input.onchange=e=>{ const file=e.target.files[0]; const reader=new FileReader(); reader.onload=ev=>{ data=JSON.parse(ev.target.result); salvarDados(); gerar(); showToast('Importado JSON'); }; reader.readAsText(file); }; input.click(); };
const gerarPDF=()=>{ html2pdf().from(document.getElementById('conteudo')).save('checklist.pdf'); showToast('PDF gerado'); };

const exportarParaCalendario=()=>{
  let icsContent='BEGIN:VCALENDAR\nVERSION:2.0\nCALSCALE:GREGORIAN\n';
  const startDate=new Date();
  let semanaCount=0;
  for(const semana in plano){
    semanaCount++;
    const dt=new Date(startDate.getTime()+7*(semanaCount-1)*24*60*60*1000);
    icsContent+=`BEGIN:VEVENT\nUID=${semanaCount}@checklist.com\nDTSTAMP:${dt.toISOString().replace(/[-:]/g,'').split('.')[0]}Z\nDTSTART:${dt.toISOString().replace(/[-:]/g,'').split('.')[0]}Z\nSUMMARY:${semana}\nEND:VEVENT\n`;
  }
  icsContent+='END:VCALENDAR';
  const blob=new Blob([icsContent],{type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='checklist.ics'; a.click(); showToast('Calendário exportado');
};

// ================= Progress/Badges ======================
const atualizarProgresso=()=>{
  const total=document.querySelectorAll('.tarefas input').length;
  const marcados=document.querySelectorAll('.tarefas input:checked').length;
  const percent=Math.round((marcados/total)*100);
  document.getElementById('progressBar').style.width=percent+'%'; document.getElementById('progressBar').textContent=percent+'%';
  Object.keys(plano).forEach((s,idx)=>{
    const inputs=document.querySelectorAll(`#tarefas-${idx} input`);
    const marcadosSemana=[...inputs].filter(i=>i.checked).length;
    const fill=document.getElementById(`semana-progress-fill-${idx}`);
    fill.style.width=(marcadosSemana/inputs.length*100)+'%';
  });
};

const atualizarBadges=()=>{
  const container=document.getElementById('badges-container'); container.innerHTML='';
  let badges=[];
  Object.keys(plano).forEach((s,idx)=>{ if([...document.querySelectorAll(`#tarefas-${idx} input`)].every(i=>i.checked)) badges.push(s); });
  data.badges=badges;
  badges.forEach(b=>{ const span=document.createElement('span'); span.className='badge'; span.textContent='⭐ '+b; container.appendChild(span); });
};

// ================= Tema ======================
const toggleTheme=()=>{ data.dark=!data.dark; document.body.classList.toggle('dark-mode',data.dark); salvarDados(); };

// ================= Limpar ======================
const limpar=()=>{ if(confirm('Deseja limpar tudo?')){ data={check:{},notes:{},dark:data.dark,historico:[],pontos:0,badges:[]}; salvarDados(); gerar(); showToast('Tudo limpo'); }};

// ================= Login Google ======================
async function mostrarUsuario() {
  const token = JSON.parse(localStorage.getItem('googleToken'));
  const emailSpan = document.getElementById('usuario-email');
  const avatarImg = document.getElementById('usuario-avatar');

  if (!token) {
    emailSpan.textContent = "Nenhuma conta conectada";
    avatarImg.style.display = "none";
    return;
  }

  try {
    const resp = await fetch(`${BACKEND_URL}/userinfo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    });

    if (!resp.ok) throw new Error("Erro ao obter usuário");

    const perfil = await resp.json();
    emailSpan.textContent = perfil.email || "Usuário sem email";
    if (perfil.picture) {
      avatarImg.src = perfil.picture;
      avatarImg.style.display = "inline-block";
    } else {
      avatarImg.style.display = "none";
    }
  } catch (e) {
    console.error(e);
    emailSpan.textContent = "Erro ao obter usuário";
    avatarImg.style.display = "none";
  }
}

// Login Google
window.loginGoogle = () => {
  fetch(`${BACKEND_URL}/auth-url`)
    .then(res => res.json())
    .then(d => {
      const popup = window.open(d.url, "loginGoogle", "width=500,height=600");
      if (!popup) return showToast("Não foi possível abrir popup");

      // Listener de mensagem
      const handleMessage = async (e) => {
        if (e.data.googleToken) {
          localStorage.setItem('googleToken', JSON.stringify(e.data.googleToken));
          await mostrarUsuario();
          showToast('Login concluído');
          popup.close();
        }
      };

      window.addEventListener('message', handleMessage, { once: true });
    })
    .catch(err => {
      console.error(err);
      showToast("Erro ao obter URL de login");
    });
};

// Logout Google
window.logoutGoogle = () => {
  localStorage.removeItem('googleToken');
  mostrarUsuario();
  showToast('Logout realizado');
};

// Salvar no Drive
window.salvarNoDrive = async () => {
  const token = JSON.parse(localStorage.getItem('googleToken'));
  if (!token) return showToast('Faça login antes de salvar no Drive');

  try {
    const resp = await fetch(`${BACKEND_URL}/save`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, filename: 'checklist.json', content: data })
    });

    const resultado = await resp.json();
    if (resultado.success) showToast(`Checklist salvo! ID: ${resultado.fileId}`);
    else showToast(`Erro: ${resultado.error || 'Desconhecido'}`);
  } catch (e) {
    console.error(e);
    showToast('Erro ao salvar no Drive');
  }
};

// ================= Inicialização ======================
document.body.classList.toggle('dark-mode',data.dark);
gerar();
mostrarUsuario();
</script>
