<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist v3 - JavaScript Avan√ßado</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', Arial, sans-serif; margin:10px; transition: background 0.3s, color 0.3s; }
.dark-mode { background:#1e1e1e; color:#f4f4f9; }
h2 { margin-top:0; cursor:pointer; }
.semana { border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:15px; transition: background 0.3s; }
.semana.modo-revisao { background: #fff3cd !important; }
.nota { width:100%; min-height:50px; margin-top:10px; padding:8px; }
.top-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.progress { margin:20px 0; height:20px; background:#ddd; border-radius:10px; overflow:hidden; }
.progress-bar { height:100%; width:0; background:#4caf50; text-align:center; color:white; line-height:20px; transition: width 0.3s; }
.semana-header { display:flex; justify-content:space-between; align-items:center; }
.semana-progress { font-size:0.9em; margin-top:5px; color:#666; }
.dark-mode .semana-progress { color:#ccc; }
.semana-progress-bar { width:100%; height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-top:5px; }
.semana-progress-fill { height:100%; width:0; background:#4caf50; transition: width 0.3s; }
.hidden { display:none; }
button { cursor:pointer; border:none; border-radius:5px; padding:5px 10px; background-color:#4caf50; color:white; transition: background 0.2s; }
button:hover { background-color:#45a049; }
input[type=text] { padding:5px; border-radius:5px; border:1px solid #ccc; }
.importante { color:red; font-weight:bold; cursor:pointer; margin-left:5px; }
.confete { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
.badge { display:inline-block; padding:3px 6px; border-radius:5px; background:#FFD700; color:#000; margin:2px; font-size:0.8em; }
.tempo { font-size:0.8em; color:#555; margin-left:5px; }
#badges-container { margin-bottom:10px; }
@media (max-width:600px){ .top-bar{flex-direction:column;} }
</style>
</head>
<body>

<div class="top-bar">
  <button onclick="toggleTheme()">üåô/‚òÄÔ∏è Tema</button>
  <button onclick="exportar()">Exportar JSON</button>
  <button onclick="exportarAvancado()">Exportar Avan√ßado</button>
  <button onclick="importar()">Importar JSON</button>
  <button onclick="limpar()">Limpar Tudo</button>
  <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrar()">
  <button onclick="gerarPDF()">Exportar PDF</button>
  <button onclick="ativarModoRevisao()">Modo Revis√£o</button>
  <button onclick="exportarParaCalendario()">Exportar Calend√°rio</button>
  <button onclick="loginGoogle()">Login Google</button>
  <button onclick="salvarNoDrive()">Salvar no Drive</button>
</div>

<div id="badges-container"></div>
<div class="progress"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="conteudo"></div>
<div id="confete-container" class="confete"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
const BACKEND_URL = 'https://cursojs-8012.onrender.com';

// --- LOGIN GOOGLE ---
window.addEventListener('load', () => {
  const params = new URLSearchParams(window.location.search);
  const tokenStr = params.get('token');
  if(tokenStr){
    try {
      const token = JSON.parse(decodeURIComponent(tokenStr));
      localStorage.setItem('googleToken', JSON.stringify(token));
      console.log('Token do Google salvo localmente');
      window.history.replaceState({}, document.title, window.location.pathname);
      alert('Login Google conclu√≠do!');
    } catch(e){
      console.error("Erro ao processar token do Google:", e);
    }
  }
});

function loginGoogle() {
  fetch(`${BACKEND_URL}/auth-url`)
    .then(res => res.json())
    .then(data => { window.location.href = data.url; });
}

function salvarNoDrive() {
  const token = JSON.parse(localStorage.getItem('googleToken'));
  if (!token) return alert('Voc√™ precisa fazer login no Google antes.');
  const data = JSON.stringify(semanas);
  fetch(`${BACKEND_URL}/save`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ token, filename:'checklist.json', content: data })
  })
  .then(res => res.json())
  .then(resp => {
    if(resp.success) alert('Checklist salvo com sucesso no Google Drive!');
    else alert('Erro ao salvar: ' + (resp.error || 'desconhecido'));
  })
  .catch(err => alert('Erro ao salvar no Google Drive: ' + err));
}

// --- CHECKLIST ANTIGO ---
let semanas = [];

function carregar() {
  const salvo = localStorage.getItem('checklist');
  semanas = salvo ? JSON.parse(salvo) : gerarSemanas(12);
  renderizar();
}

function gerarSemanas(qtd) {
  let arr = [];
  for(let i=1;i<=qtd;i++){
    arr.push({ titulo:"Semana "+i, tarefas:[], notas:"", concluido:0, total:0 });
  }
  return arr;
}

function salvar() {
  localStorage.setItem('checklist', JSON.stringify(semanas));
  atualizarProgresso();
}

function renderizar() {
  const container = document.getElementById('conteudo');
  container.innerHTML = '';
  semanas.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'semana';
    div.innerHTML = `
      <div class="semana-header">
        <h2 onclick="toggleSemana(${i})">${s.titulo}</h2>
        <span class="semana-progress">${s.concluido}/${s.total}</span>
      </div>
      <div id="semana-${i}">
        <textarea class="nota" oninput="editarNota(${i}, this.value)">${s.notas||''}</textarea>
      </div>
      <div class="semana-progress-bar"><div class="semana-progress-fill" style="width:${s.total?s.concluido/s.total*100:0}%"></div></div>
    `;
    container.appendChild(div);
  });
  atualizarProgresso();
}

function editarNota(i, val){ semanas[i].notas = val; salvar(); }
function toggleSemana(i){ const el=document.getElementById('semana-'+i); el.classList.toggle('hidden'); }

function atualizarProgresso() {
  let total=0, concl=0;
  semanas.forEach(s => { total+=s.total; concl+=s.concluido; });
  const pct = total? Math.round(concl/total*100):0;
  const bar = document.getElementById('progressBar');
  bar.style.width = pct+'%';
  bar.innerText = pct+'%';
}

// --- Fun√ß√µes auxiliares antigas ---
function toggleTheme(){ document.body.classList.toggle('dark-mode'); }
function exportar(){ const blob=new Blob([JSON.stringify(semanas)],{type:'application/json'}); baixar(blob,'checklist.json'); }
function exportarAvancado(){ gerarPDF(); }
function importar(){ const inp=document.createElement('input'); inp.type='file'; inp.onchange=e=>{const f=e.target.files[0]; f.text().then(txt=>{ semanas=JSON.parse(txt); salvar(); renderizar(); });}; inp.click(); }
function limpar(){ if(confirm('Tem certeza?')){ localStorage.removeItem('checklist'); semanas=gerarSemanas(12); renderizar(); } }
function filtrar(){ const termo=document.getElementById('busca').value.toLowerCase(); document.querySelectorAll('.semana').forEach(div=>{div.style.display=div.innerText.toLowerCase().includes(termo)?'block':'none';}); }
function gerarPDF(){ html2pdf().from(document.body).save('checklist.pdf'); }
function ativarModoRevisao(){ document.querySelectorAll('.semana').forEach(div=>div.classList.toggle('modo-revisao')); }
function exportarParaCalendario(){ alert('Exportar para calend√°rio ainda n√£o implementado.'); }
function baixar(blob,nome){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=nome; a.click(); URL.revokeObjectURL(url); }

window.onload = carregar;
</script>
</body>
</html>
