<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checklist v4.1 - JavaScript Avan√ßado</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ---------- Global ---------- */
body { font-family: 'Inter', Arial, sans-serif; margin:10px; transition: background 0.3s, color 0.3s; }
.dark-mode { background:#1e1e1e; color:#f4f4f9; }

/* ---------- Top Bar ---------- */
.top-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.top-bar button { cursor:pointer; border:none; border-radius:5px; padding:8px 12px; background-color:#4caf50; color:white; transition: background 0.2s; }
.top-bar button:hover { background-color:#45a049; }
.top-bar input[type=text] { padding:6px; border-radius:5px; border:1px solid #ccc; flex:1; min-width:150px; }

/* ---------- Semanas / Cards ---------- */
.semana { border:1px solid #ccc; border-radius:8px; padding:10px; margin-bottom:15px; transition: all 0.3s ease; max-width:500px; margin-left:auto; margin-right:auto; }
.semana-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.semana-header h2:hover { text-decoration: underline; }
.semana-progress { font-size:0.9em; margin-top:5px; color:#666; }
.dark-mode .semana-progress { color:#ccc; }
.semana-progress-bar { width:100%; height:10px; background:#ddd; border-radius:5px; overflow:hidden; margin-top:5px; }
.semana-progress-fill { height:100%; width:0; background:#4caf50; transition: width 0.3s; }
.semana.modo-revisao { background: #fff3cd !important; }

/* ---------- Tarefas ---------- */
.semana div > input[type=checkbox] { margin-right:8px; transform:scale(1.2); cursor:pointer; }
.semana div label { display:block; padding:6px 4px; font-size:14px; cursor:pointer; }

/* ---------- Notas ---------- */
.nota { width:100%; min-height:80px; margin-top:10px; padding:8px; font-size:14px; }

/* ---------- Progress ---------- */
.progress { margin:20px 0; height:20px; background:#ddd; border-radius:10px; overflow:hidden; }
.progress-bar { height:100%; width:0; background:#4caf50; text-align:center; color:white; line-height:20px; transition: width 0.3s; }

/* ---------- Confete ---------- */
.confete { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }

/* ---------- Badges ---------- */
.badge { display:inline-block; padding:3px 6px; border-radius:5px; background:#FFD700; color:#000; margin:2px; font-size:0.8em; }

/* ---------- Responsividade ---------- */
@media (max-width:600px){
  .top-bar { flex-direction: column; gap:5px; }
  .top-bar button { width:100%; font-size:14px; padding:8px 0; }
  .progress, .semana-progress-bar { height:18px; }
  .progress-bar, .semana-progress-fill { line-height:18px; font-size:12px; }
  #confete-container { display:none; }
  .semana div[id^="tarefas-"] { display:none; }
}
</style>
</head>
<body>

<div class="top-bar">
  <button onclick="toggleTheme()">üåô/‚òÄÔ∏è Tema</button>
  <button onclick="exportar()">Exportar JSON</button>
  <button onclick="exportarAvancado()">Exportar Avan√ßado</button>
  <button onclick="importar()">Importar JSON</button>
  <button onclick="limpar()">Limpar Tudo</button>
  <input type="text" id="busca" placeholder="Buscar..." onkeyup="filtrar()">
  <button onclick="gerarPDF()">Exportar PDF</button>
  <button onclick="ativarModoRevisao()">Modo Revis√£o</button>
  <button onclick="exportarParaCalendario()">Exportar Calend√°rio</button>
  <button onclick="loginGoogle()">Login Google</button>
  <button onclick="salvarNoDrive()">Salvar no Drive</button>
</div>

<div id="badges-container"></div>
<div class="progress"><div class="progress-bar" id="progressBar">0%</div></div>
<div id="conteudo"></div>
<div id="confete-container" class="confete"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ================= BACKEND URL =================
const BACKEND_URL = 'https://cursojs-8012.onrender.com';

// ================= CHECKLIST =================
const coresSemana = ['#FFCDD2','#C8E6C9','#BBDEFB','#FFF9C4','#D1C4E9','#FFE0B2','#B2DFDB','#F8BBD0'];
const plano = {
  "Semana 1 ‚Äì Fundamentos": ["O que √© JS, onde roda, configurar ambiente.", "Vari√°veis (let, const, var) e tipos de dados.", "Operadores matem√°ticos e de compara√ß√£o.", "Operadores l√≥gicos (&&, ||, !).", "Exerc√≠cios pr√°ticos (mini-calculadora, ol√° usu√°rio)."],
  "Semana 2 ‚Äì Controle de Fluxo": ["if, else if, else.", "Operador tern√°rio e switch.", "Estruturas de repeti√ß√£o: for.", "Estruturas de repeti√ß√£o: while e do...while.", "Exerc√≠cios pr√°ticos (tabuada, par/√≠mpar)."],
  "Semana 3 ‚Äì Fun√ß√µes e Escopo": ["Declara√ß√£o de fun√ß√µes e par√¢metros.", "Retorno de fun√ß√µes.", "Arrow functions.", "Escopo (global, local, bloco).", "Fun√ß√µes an√¥nimas, setTimeout e setInterval."],
  "Semana 4 ‚Äì Arrays e Objetos": ["Criar arrays e usar .push(), .pop().", ".map(), .filter(), .reduce().", "Objetos: propriedades e acesso (. e []).", "Itera√ß√£o em objetos (for...in, Object.keys).", "Exerc√≠cios (lista de compras, objeto carro)."],
  "Semana 5 ‚Äì DOM": ["Selecionar elementos (getElementById, querySelector).", "Alterar conte√∫do (innerText, innerHTML).", "Alterar estilos (.style).", "Criar e remover elementos (createElement, appendChild).", "Eventos (onclick, addEventListener)."],
  "Semana 6 ‚Äì Projeto To-Do List": ["Estrutura HTML b√°sica e input para tarefas.", "Adicionar itens √† lista com JS.", "Marcar tarefas como conclu√≠das.", "Excluir tarefas.", "Melhorias: salvar no localStorage."],
  "Semana 7 ‚Äì JavaScript Moderno": ["Template literals e desestrutura√ß√£o.", "Spread/rest.", "M√≥dulos (import e export).", "fetch e Promises.", "async/await."],
  "Semana 8 ‚Äì Projeto Final": ["Planejar o projeto (ex.: clima, quiz, galeria).", "Estruturar HTML/CSS inicial.", "Criar fun√ß√µes principais.", "Consumir API (se usar).", "Finalizar e adicionar melhorias extras."]
};

let data = JSON.parse(localStorage.getItem('data')) || { check: {}, notes: {}, dark: false, historico: [], pontos: 0, badges: [] };
let modoRevisaoAtivo = false;

// ---------- Fun√ß√µes ----------

// Salvar/Carregar
const salvar = () => { localStorage.setItem('data', JSON.stringify(data)); atualizarProgresso(); atualizarBadges(); };
const carregar = () => { gerar(); if(data.dark) document.body.classList.add('dark-mode'); atualizarProgresso(); atualizarBadges(); };

// Tema
const toggleTheme = () => { document.body.classList.toggle('dark-mode'); data.dark = document.body.classList.contains('dark-mode'); salvar(); };

// Cria√ß√£o de tarefas
const criarTarefa = (semana, idx, t, i) => {
  const chk = document.createElement('input'); chk.type='checkbox'; chk.id=`s${idx}d${i}`; chk.checked=data.check[chk.id]||false;
  chk.onchange=()=>{ data.check[chk.id]=chk.checked; salvar(); checarConfete(idx); adicionarHistorico(semana,t,chk.checked); if(modoRevisaoAtivo) ativarModoRevisao(); };
  const label = document.createElement('label'); label.htmlFor=chk.id; label.textContent=t;
  const div=document.createElement('div'); div.appendChild(chk); div.appendChild(label); return div;
};

// Gerar semanas
const gerarSemana = (semana, tarefas, idx) => {
  const div=document.createElement('div'); div.className='semana'; div.style.background=coresSemana[idx%coresSemana.length];
  const header=document.createElement('div'); header.className='semana-header';
  header.innerHTML=`<h2 onclick='toggleCollapse(${idx})'>${semana}</h2>
    <div>
      <button onclick='marcarSemana(${idx},true)'>Marcar todos</button>
      <button onclick='marcarSemana(${idx},false)'>Resetar</button>
    </div>`;
  div.appendChild(header);
  const progresso=document.createElement('div'); progresso.className='semana-progress'; progresso.id=`semana-progress-${idx}`; div.appendChild(progresso);
  const progressBar=document.createElement('div'); progressBar.className='semana-progress-bar';
  progressBar.innerHTML=`<div class='semana-progress-fill' id='semana-progress-fill-${idx}'></div>`; div.appendChild(progressBar);
  const tarefasDiv=document.createElement('div'); tarefasDiv.id=`tarefas-${idx}`; tarefas.forEach((t,i)=>tarefasDiv.appendChild(criarTarefa(semana, idx, t, i))); div.appendChild(tarefasDiv);
  return div;
};

// Gerar interface
const gerar = () => {
  const container=document.getElementById('conteudo'); container.innerHTML='';
  Object.entries(plano).forEach(([semana,tarefas],idx)=>container.appendChild(gerarSemana(semana,tarefas,idx)));
  atualizarProgresso();
  if(modoRevisaoAtivo) ativarModoRevisao();
};

// Collapse
const toggleCollapse = idx => {
  const el=document.getElementById(`tarefas-${idx}`);
  el.style.display = el.style.display==='none'?'block':'none';
};

// Marcar todas/resetar
const marcarSemana = (idx, marcar) => { document.querySelectorAll(`#tarefas-${idx} input[type=checkbox]`).forEach(chk=>{ chk.checked=marcar; data.check[chk.id]=marcar; }); salvar(); };

// Confete
const checarConfete = idx => { const semana=plano[Object.keys(plano)[idx]]; if(semana.every((_,i)=>data.check[`s${idx}d${i}`])){ const confete=document.getElementById('confete-container'); confete.innerHTML='üéâ'.repeat(20); setTimeout(()=>confete.innerHTML='',1500); } };

// Hist√≥rico
const adicionarHistorico = (semana,tarefa,status)=>{ data.historico.push({semana,tarefa,status,timestamp:new Date().toISOString()}); if(data.historico.length>100) data.historico.shift(); salvar(); };

// Export/Import
const criarDownload=(json,nome)=>{ const blob=new Blob([JSON.stringify(json,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=nome; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);}
const exportar = () => criarDownload(data,'checklist.json');
const exportarAvancado = () => criarDownload({check:data.check,notes:data.notes,historico:data.historico,pontos:data.pontos,badges:data.badges},'checklist_avancado.json');
const importar = () => { const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=e=>{ const file=e.target.files[0]; if(file){ const reader=new FileReader(); reader.onload=evt=>{ try{ data=JSON.parse(evt.target.result); salvar(); gerar(); } catch{ alert('Arquivo inv√°lido!'); } }; reader.readAsText(file); } }; input.click(); };
const limpar = () => { if(confirm("Deseja realmente limpar todos os dados?")){ data={check:{},notes:{},dark:false,historico:[],pontos:0,badges:[]}; localStorage.removeItem('data'); carregar(); } };

// Progresso/Badges
const atualizarProgresso=()=>{
  const totalTarefas=Object.keys(data.check).length;
  const concluidas=Object.values(data.check).filter(Boolean).length;
  const perc=totalTarefas?Math.round(concluidas/totalTarefas*100):0;
  document.getElementById('progressBar').style.width=perc+'%';
  document.getElementById('progressBar').textContent=perc+'%';
  Object.keys(plano).forEach((semana,idx)=>{
    const tarefas=plano[semana];
    const conclu=tarefas.filter((_,i)=>data.check[`s${idx}d${i}`]).length;
    const percSemana=tarefas.length?Math.round(conclu/tarefas.length*100):0;
    const fill=document.getElementById(`semana-progress-fill-${idx}`);
    const txt=document.getElementById(`semana-progress-${idx}`);
    if(fill) fill.style.width=percSemana+'%';
    if(txt) txt.textContent=percSemana+'% conclu√≠do';
  });
};

const atualizarBadges=()=>{
  const container=document.getElementById('badges-container'); container.innerHTML='';
  ['10 Tarefas','20 Tarefas'].forEach((b,i)=>{ if(data.pontos>=(i+1)*10 && !data.badges.includes(b)) data.badges.push(b); });
  data.badges.forEach(b=>{ const span=document.createElement('span'); span.className='badge'; span.textContent=b; container.appendChild(span); });
};

// Modo Revis√£o
const ativarModoRevisao=()=>{ modoRevisaoAtivo=!modoRevisaoAtivo; document.querySelectorAll('.semana').forEach(div=>{ if(modoRevisaoAtivo && [...div.querySelectorAll('input[type=checkbox]')].some(chk=>!chk.checked)){ div.classList.add('modo-revisao'); } else { div.classList.remove('modo-revisao'); } }); alert(`Modo Revis√£o ${modoRevisaoAtivo?'Ativado':'Desativado'}`); };

// Busca
const filtrar = () => { const termo=document.getElementById('busca').value.toLowerCase(); document.querySelectorAll('.semana').forEach(div=>{ div.style.display = div.innerText.toLowerCase().includes(termo)?'block':'none'; }); };

// PDF
const gerarPDF=()=>html2pdf().from(document.getElementById('conteudo')).save('checklist.pdf');

// Calend√°rio
const exportarParaCalendario=()=>{
  let ics="BEGIN:VCALENDAR\nVERSION:2.0\n";
  let baseDate=new Date();
  Object.keys(plano).forEach((semana,idx)=>{
    plano[semana].forEach((t,i)=>{
      if(data.check[`s${idx}d${i}`]){
        let dt=new Date(baseDate.getTime()+idx*7*24*60*60*1000);
        let dtStr=dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
        ics+=`BEGIN:VEVENT\nSUMMARY:${t}\nDTSTART:${dtStr}\nEND:VEVENT\n`;
      }
    });
  });
  ics+="END:VCALENDAR";
  const blob=new Blob([ics],{type:'text/calendar'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='checklist.ics'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
};

// ================= LOGIN GOOGLE =================
window.addEventListener('load',()=>{
  const params=new URLSearchParams(window.location.search);
  const tokenStr=params.get('token');
  if(tokenStr){ try{ const token=JSON.parse(decodeURIComponent(tokenStr)); localStorage.setItem('googleToken',JSON.stringify(token)); console.log('Token do Google salvo'); window.history.replaceState({},document.title,window.location.pathname); alert('Login Google conclu√≠do!'); }catch(e){console.error(e);} }
});

function loginGoogle(){
  fetch(`${BACKEND_URL}/auth-url`).then(res=>res.json()).then(data=>{
    const popup=window.open(data.url,"loginGoogle","width=500,height=600");
    window.addEventListener("message",function(event){
      if(event.data.googleToken){ localStorage.setItem('googleToken',JSON.stringify(event.data.googleToken)); alert('Login Google conclu√≠do!'); popup.close(); }
    },{once:true});
  });
}

function salvarNoDrive(){
  const token=JSON.parse(localStorage.getItem('googleToken'));
  if(!token) return alert('Voc√™ precisa fazer login no Google antes.');
  fetch(`${BACKEND_URL}/save`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token,filename:'checklist.json',content:data}) })
  .then(res=>res.json()).then(resp=>{ if(resp.success) alert('Checklist salvo com sucesso no Google Drive!'); else alert('Erro: '+(resp.error||'desconhecido')); })
  .catch(err=>alert('Erro ao salvar no Google Drive: '+err));
}

window.onload=carregar;
</script>
</body>
</html>
